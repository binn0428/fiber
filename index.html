<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>資料查詢系統</title>
    
    <!-- PWA & Favicon -->
    <link rel="icon" type="image/webp" href="faq-002.webp">
    <link rel="manifest" href="manifest.json">
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('Service Worker registered'))
            .catch(err => console.log('Service Worker registration failed: ', err));
        });
      }
        // ================= PROGRESS BAR LOGIC =================
    function showProgress(title = '處理中...') {
        document.getElementById('progressTitle').innerText = title;
        document.getElementById('progressBar').style.width = '0%';
        document.getElementById('progressBar').innerText = '0%';
        document.getElementById('progressMessage').innerText = '';
        document.getElementById('progressModal').style.display = 'flex';
    }

    function updateProgress(percent, message) {
        const p = Math.round(percent);
        document.getElementById('progressBar').style.width = p + '%';
        document.getElementById('progressBar').innerText = p + '%';
        if (message) document.getElementById('progressMessage').innerText = message;
    }

    function hideProgress() {
        document.getElementById('progressModal').style.display = 'none';
    }

    // ================= MODIFICATION RECORD LOGIC =================
    function showModRecordPage() {
        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('modRecordPage').classList.remove('hidden');
        
        // Show/Hide Search Logs button based on role
        if (currentUser && currentUser.role === 'admin') {
            document.getElementById('searchLogContainer').classList.remove('hidden');
        } else {
            document.getElementById('searchLogContainer').classList.add('hidden');
        }

        // Push state to history for Back button support
        window.history.pushState({ page: 'modRecord' }, '', '#modRecord');
        // Load initial times
        updateLastModTimes();
    }

    function hideModRecordPage() {
        document.getElementById('modRecordPage').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        // Clean URL if needed, but usually popstate handles it. 
        // If called manually (btn click), we should go back to avoid forward history trap
        if (window.location.hash === '#modRecord') {
            window.history.back();
        }
    }

    // Handle Back Button with Double Press Exit Logic
    let lastBackPressTime = 0;
    
    // Initialize History State for Main Page Exit Trap
    window.addEventListener('load', () => {
        // Replace current state to be 'home' to ensure we have a state object
        window.history.replaceState({ page: 'home' }, '', window.location.pathname);
        // Push a guard state so we can intercept the first back press
        window.history.pushState({ page: 'home_guard' }, '', window.location.pathname);
    });

    window.addEventListener('popstate', function(event) {
        const modPage = document.getElementById('modRecordPage');
        
        // Scenario 1: Back from Mod Page
        // If Mod Page is visible, we hide it and return to Main App.
        if (!modPage.classList.contains('hidden')) {
             modPage.classList.add('hidden');
             document.getElementById('mainApp').classList.remove('hidden');
             // We don't need to do anything else as the history pop already happened.
             return;
        }
        
        // Scenario 2: Back at Main Page (Exit Logic)
        // If we are here, Mod Page is hidden.
        
        const currentTime = new Date().getTime();
        const timeDiff = currentTime - lastBackPressTime;
        
        if (timeDiff < 2000) {
            // Second press within 2 seconds -> Confirm Exit
            if (confirm('確定要離開系統嗎？')) {
                // User confirmed. Go back one more time to exit or close window
                // Note: window.close() only works if script opened window. 
                // history.back() might exit PWA or browser tab depending on history stack.
                window.history.back(); 
            } else {
                // Cancelled. Restore the guard state.
                window.history.pushState({ page: 'home_guard' }, '', window.location.pathname);
            }
        } else {
            // First press
            lastBackPressTime = currentTime;
            
            // Show toast/hint
            const toast = document.createElement('div');
            toast.innerText = '再按一次離開';
            toast.style.position = 'fixed';
            toast.style.bottom = '50px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.background = 'rgba(0,0,0,0.7)';
            toast.style.color = 'white';
            toast.style.padding = '10px 20px';
            toast.style.borderRadius = '20px';
            toast.style.zIndex = '9999';
            toast.style.pointerEvents = 'none';
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 2000);
            
            // Restore guard state so next press triggers popstate again
            window.history.pushState({ page: 'home_guard' }, '', window.location.pathname);
        }
    });

    async function updateLastModTimes() {
        const tables = ['phones', 'dispatch_phones', 'images'];
        for (const table of tables) {
            const { data, error } = await supabaseClient
                .from('modification_logs')
                .select('modified_at')
                .eq('table_name', table)
                .order('modified_at', { ascending: false })
                .limit(1);
            
            const el = document.getElementById(`lastModTime-${table}`);
            if (el) {
                if (data && data.length > 0) {
                    el.innerText = '最新修改: ' + new Date(data[0].modified_at).toLocaleString();
                } else {
                    el.innerText = '最新修改: 無紀錄';
                }
            }
        }
    }

    async function loadModRecords(table) {
        const listDiv = document.getElementById('modRecordList');
        listDiv.innerHTML = '<p style="text-align: center;">載入中...</p>';
        
        const { data, error } = await supabaseClient
            .from('modification_logs')
            .select('*')
            .eq('table_name', table)
            .order('modified_at', { ascending: false })
            .limit(200); // Limit to last 200 records
            
        if (error) {
            listDiv.innerHTML = `<p style="color: red; text-align: center;">載入失敗: ${error.message}</p>`;
            return;
        }

        if (!data || data.length === 0) {
            listDiv.innerHTML = '<p style="text-align: center; color: #888;">尚無修改紀錄</p>';
            return;
        }

        // Add Export Button
        let html = `
        <div style="text-align: right; margin-bottom: 10px;">
            ${(table === 'search_logs' && currentUser && currentUser.role === 'admin') ? 
                `<button onclick="clearAllModLogs('${table}')" style="background: #d32f2f; padding: 5px 15px; font-size: 0.9em; border-radius: 4px; color: white; border: none; cursor: pointer; margin-right: 10px;">清空此紀錄</button>` : ''}
            <button onclick="exportModLogs('${table}')" style="background: #009688; padding: 5px 15px; font-size: 0.9em; border-radius: 4px; color: white; border: none; cursor: pointer;">匯出此紀錄</button>
        </div>`;

        data.forEach(log => {
            const time = new Date(log.modified_at).toLocaleString();
            let actionColor = '#555';
            let actionText = log.action;
            if (log.action === 'UPDATE') { actionColor = '#2196F3'; actionText = '修改'; }
            if (log.action === 'DELETE') { actionColor = '#F44336'; actionText = '刪除'; }
            if (log.action === 'INSERT') { actionColor = '#4CAF50'; actionText = '新增'; }
            if (log.action === 'SEARCH') { actionColor = '#9C27B0'; actionText = '查詢'; }
            if (log.action === 'IMPORT') { actionColor = '#FF9800'; actionText = '匯入'; }
            if (log.action === 'EXPORT') { actionColor = '#00BCD4'; actionText = '匯出'; }

            let deleteBtn = '';
            if (currentUser && currentUser.role === 'admin') {
                deleteBtn = `<button onclick="deleteModLog('${log.id}', '${table}')" style="background:#d32f2f; color:white; border:none; padding:2px 6px; border-radius:3px; font-size:0.8em; margin-left:10px; cursor:pointer; min-width: 20px;">X</button>`;
            }

            // Correctly display Admin name for existing records if username matches specific ID or if role was admin at time (but we only have modified_by string)
            let modifierDisplay = log.modified_by || 'Unknown';
            if (modifierDisplay === '179747' || modifierDisplay === 'admin') {
                modifierDisplay = '管理者';
            }

            // Collapsible Details using <details>
            html += `
            <details class="mod-log-card">
                <summary class="mod-log-header" style="cursor: pointer;">
                    <div style="display:flex; gap:12px; align-items:center;">
                        <span style="color: ${actionColor}; font-weight:bold; min-width: 40px;">${actionText}</span>
                        <span style="font-weight:bold; color:#333;">${modifierDisplay}</span>
                        <span style="color: #666; font-size: 0.9em;">(點擊展開)</span>
                        ${deleteBtn}
                    </div>
                    <span class="mod-log-time">${time}</span>
                </summary>
                <div class="mod-log-content" style="margin-top: 5px; border-top: 1px solid #f0f0f0; padding-top: 5px;">
                    <div style="background: #fcfcfc; padding: 5px; border-radius: 4px; border: 1px solid #eee; white-space: pre-wrap; color: #444;">${log.changed_fields || log.content || '無詳細內容'}</div>
                </div>
            </details>`;
        });
        
        listDiv.innerHTML = html;
    }

    async function deleteModLog(id, table) {
        if (!currentUser || currentUser.role !== 'admin') {
            alert('只有管理員可以刪除紀錄');
            return;
        }
        if (!confirm('確定刪除此紀錄？')) return;
        
        try {
            const { error } = await supabaseClient
                .from('modification_logs')
                .delete()
                .eq('id', id);
                
            if (error) throw error;
            
            // Reload logs
            loadModRecords(table);
        } catch (e) {
            console.error('Delete log error:', e);
            alert('刪除失敗: ' + (e.message || e));
        }
    }

    async function exportModLogs(table) {
        const btn = event.target;
        const originalText = btn.innerText;
        btn.innerText = '匯出中...';
        btn.disabled = true;

        try {
            const { data, error } = await supabaseClient
                .from('modification_logs')
                .select('*')
                .eq('table_name', table)
                .order('modified_at', { ascending: false })
                .limit(1000);
                
            if (error) throw error;
            if (!data || data.length === 0) {
                alert('無資料可匯出');
                return;
            }
            
            const exportData = data.map(log => ({
                '動作': log.action,
                '修改人': log.modified_by,
                '時間': new Date(log.modified_at).toLocaleString(),
                '內容': log.changed_fields || log.content,
                '紀錄ID': log.record_id
            }));
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Modification Logs");
            
            let label = '未知';
            if (table === 'phones') label = '分機';
            else if (table === 'dispatch_phones') label = '調度';
            else if (table === 'images') label = 'PA天車';
            else if (table === 'search_logs') label = '查詢';

            XLSX.writeFile(wb, `${label}_修改紀錄.xlsx`);
            
        } catch (e) {
            console.error('Export logs error:', e);
            alert('匯出失敗');
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    async function clearAllModLogs(table) {
        if (!currentUser || currentUser.role !== 'admin') {
            alert('只有管理員可以清空修改紀錄');
            return;
        }
        
        let label = '未知';
        if (table === 'phones') label = '分機';
        else if (table === 'dispatch_phones') label = '調度';
        else if (table === 'images') label = 'PA天車';
        else if (table === 'search_logs') label = '查詢';

        if (!confirm(`確定要清空所有「${label}」的紀錄嗎？此動作無法復原！`)) return;
        
        try {
            const { error } = await supabaseClient
                .from('modification_logs')
                .delete()
                .eq('table_name', table);
                
            if (error) throw error;
            
            alert(`已清空所有${label}紀錄`);
            loadModRecords(table); // Refresh view
            updateLastModTimes(); // Refresh times
            
        } catch (e) {
            console.error('Clear logs error:', e);
            alert('清空失敗: ' + e.message);
        }
    }

    async function logModification(tableName, action, recordId, changes, oldData, newData) {
        if (!currentUser) return;
        
        try {
            // 1. Insert Log
            const { error } = await supabaseClient
                .from('modification_logs')
                .insert({
                    table_name: tableName,
                    record_id: String(recordId), // Ensure string
                    action: action,
                    changed_fields: changes,
                    old_data: oldData,
                    new_data: newData,
                    modified_by: currentUser.username
                });
                
            if (error) {
                console.error('Failed to log modification:', error);
            }

            // 2. Cleanup Policy: Keep 200 records OR 100 days
            // We'll perform a simple cleanup: delete logs older than 100 days
            // And delete logs beyond 200 count for this table
            
            // Cleanup > 100 days
            const dateLimit = new Date();
            dateLimit.setDate(dateLimit.getDate() - 100);
            
            // Run cleanup asynchronously (don't await to avoid blocking UI)
            (async () => {
                try {
                    // Delete older than 100 days
                    await supabaseClient
                        .from('modification_logs')
                        .delete()
                        .eq('table_name', tableName)
                        .lt('modified_at', dateLimit.toISOString());

                    // Check count and delete excess (Keep latest 200)
                    // Strategy: Get the 200th record's timestamp
                    const { data: nthRecord } = await supabaseClient
                        .from('modification_logs')
                        .select('modified_at')
                        .eq('table_name', tableName)
                        .order('modified_at', { ascending: false })
                        .range(199, 199)
                        .single();
                        
                    if (nthRecord) {
                        // Delete anything older than the 200th record
                        await supabaseClient
                            .from('modification_logs')
                            .delete()
                            .eq('table_name', tableName)
                            .lt('modified_at', nthRecord.modified_at);
                    }
                } catch (cleanupErr) {
                    console.error('Cleanup logs error:', cleanupErr);
                }
            })();

        } catch (e) {
            console.error('logModification exception:', e);
        }
    }
</script>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- XLSX for Import/Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- html2canvas for Screenshot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    

    
    <style>
        :root {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --accent-color: #3f51b5;
            --accent-hover: #5c6bc0;
            --border-color: #333;
            --input-bg: #2c2c2c;
            --card-bg: #252525;
            --shadow-color: rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            min-height: 100vh;
            background-image: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.8)), url('back.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        .container {
            max-width: 1200px;
            margin: 10px auto;
            padding: 15px;
            background: rgba(30, 30, 30, 0.95);
            height: 90vh; /* Changed from min-height to fixed height for internal scrolling */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 8px 32px 0 var(--shadow-color);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }

        #phonesTableContainer, #dispatchTableContainer {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
        }

        #imageGrid {
            flex: 1;
            overflow-y: auto;
            display: grid; /* Keep grid display */
            align-content: start; /* Prevent spacing out if few items */
        }

        h1 { font-size: 1.5rem; margin-bottom: 15px; }
        h2 { font-size: 1.3rem; margin-bottom: 12px; }
        h3 { font-size: 1.1rem; margin-bottom: 10px; }
        h1, h2, h3 { color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        /* Login Overlay */
        .login-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .login-box {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            position: relative;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            border: 1px solid var(--border-color);
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-secondary);
            transition: color 0.3s;
        }
        .close-btn:hover { color: #fff; }

        /* Inputs & Controls */
        input, select {
            padding: 8px 12px;
            margin: 5px 0;
            font-size: 14px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            width: calc(100% - 24px); /* Adjust for padding */
            transition: all 0.3s ease;
        }
        
        /* Adjust width for specific inputs if needed */
        .toolbar input { width: 100%; max-width: 300px; min-width: auto; }

        input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.3);
        }

        /* Buttons with Animation */
        button {
            cursor: pointer;
            padding: 8px 16px;
            margin: 4px;
            font-size: 14px;
            border: none;
            border-radius: 6px;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(0,0,0,0.3);
            filter: brightness(1.1);
        }

        button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Button Ripple Effect */
        button::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 5px; height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        @keyframes ripple {
            0% { transform: scale(0, 0); opacity: 1; }
            20% { transform: scale(25, 25); opacity: 1; }
            100% { transform: scale(40, 40); opacity: 0; }
        }

        button:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }

        /* Progress Modal */
        #progressModal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
        }
        #progressContent {
            background-color: #333;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: 1px solid #555;
        }
        #progressBarContainer {
            width: 100%;
            background-color: #555;
            border-radius: 4px;
            margin: 15px 0;
            overflow: hidden;
        }
        #progressBar {
            width: 0%;
            height: 20px;
            background-color: #4CAF50;
            text-align: center;
            line-height: 20px;
            color: white;
            transition: width 0.3s;
        }


        /* Utility Classes */
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .editing-cell { background-color: #fffde7; border: 2px solid #ff9800; }
        
        /* Tabs */
        .tabs { 
            display: flex; 
            margin-bottom: 25px; 
            border-bottom: 1px solid var(--border-color);
            gap: 10px;
        }
        .tab { 
            padding: 12px 25px; 
            cursor: pointer; 
            background: var(--bg-primary); 
            border-radius: 8px 8px 0 0; 
            color: var(--text-secondary);
            transition: all 0.3s;
            position: relative;
            border: 1px solid transparent;
        }
        .tab:hover { background: #252525; color: #fff; }
        .tab.active { 
            background: var(--accent-color); 
            color: white; 
            font-weight: bold;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
        }

        /* Custom Tab Colors */
        .tab.active.tab-phones {
            background: #FFD700; /* Yellow */
            color: #000;
        }
        .tab.active.tab-images {
            background: #4CAF50; /* Green */
            color: #fff;
        }

        /* Blinking Animation */
        @keyframes blink-orange {
            0% { background-color: var(--accent-color); box-shadow: 0 0 0 0 rgba(255, 165, 0, 0.7); }
            50% { background-color: #ff9800; box-shadow: 0 0 10px 5px rgba(255, 165, 0, 0.5); transform: scale(1.05); }
            100% { background-color: var(--accent-color); box-shadow: 0 0 0 0 rgba(255, 165, 0, 0); }
        }
        .blink-orange {
            animation: blink-orange 1.5s infinite;
        }

        /* Tables */
        table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0;
            margin-top: 15px; 
            background: var(--card-bg); 
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        th, td { 
            border-bottom: 1px solid var(--border-color); 
            padding: 12px 15px; 
            text-align: left; 
        }
        th { 
            background-color: #2a2a2a; 
            color: #fff; 
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }
        tr:nth-child(even) { background-color: #2f2f2f; }
        tr:hover { background-color: #383838; transition: background 0.2s; }
        
        /* Editable cells */
        td[contenteditable="true"]:hover {
            background-color: #404040;
            cursor: text;
            outline: 1px dashed #666;
        }

        /* Grid for Images */
        .image-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
            gap: 20px; 
            margin-top: 20px; 
        }
        .image-item { 
            border: 1px solid var(--border-color); 
            padding: 10px; 
            background: var(--card-bg); 
            text-align: center; 
            cursor: pointer; 
            border-radius: 8px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .image-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            border-color: var(--accent-color);
        }
        .image-item img { 
            width: 100%; 
            height: 160px; 
            object-fit: cover; 
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .toolbar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: var(--bg-primary); 
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 10px;
            flex-shrink: 0; /* Prevent shrinking */
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #777; }

        /* Clear Button Style */
        .btn-clear {
            background: #d32f2f !important; /* Red background */
            color: white;
            padding: 8px 16px !important;
            font-size: 14px;
            margin: 4px !important;
            border-radius: 6px;
            /* Remove circular styles */
            width: auto;
            height: auto;
        }

        @media (max-width: 768px) {
            .container {
                margin: 0;
                padding: 10px;
                border-radius: 0;
                min-height: 100vh;
                border: none;
            }
            
            /* Smaller Header Fonts */
            h1 { font-size: 0.9rem !important; margin-bottom: 5px; }
            #loginBtn, #userControls button { font-size: 0.75rem !important; padding: 4px 8px !important; }
            
            /* Reduce instruction text size */
            h2, h3, .toolbar input, .toolbar button, .image-grid, table { 
                font-size: 0.9rem !important; 
            }
            
            /* Row Layout for Toolbar */
            .toolbar {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
                padding: 10px;
            }

            /* Search Group Container */
            .search-group {
                display: flex;
                align-items: center;
                width: 100%;
                gap: 5px;
            }

            .toolbar input {
                width: auto !important;
                flex: 1; /* Take available space */
                margin-bottom: 0 !important;
                min-width: 0; /* Allow shrinking */
            }

            .toolbar button {
                width: auto;
                margin: 0 !important;
                padding: 2px 6px !important; /* Significantly reduced */
                font-size: 0.8rem !important; /* Smaller font */
                white-space: nowrap;
                height: 24px; /* Fixed small height */
                line-height: 1;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }

            .toolbar input {
                height: 24px !important; /* Match button height */
                font-size: 0.8rem !important;
                padding: 0 5px !important;
            }
            
            /* Remove circular clear button overrides for mobile */

            .toolbar > div:not(.search-group) {
                width: 100%;
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: flex-end; /* Align auth controls to right or distribute */
                gap: 5px;
            }

            #phonesTableContainer, #dispatchTableContainer {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin-top: 10px;
            }

            table {
                min-width: 800px; /* Ensure content isn't squashed */
            }

            .tabs {
                gap: 5px;
                margin-bottom: 15px;
            }

            .tab {
                padding: 8px 5px;
                font-size: 0.85rem;
                flex: 1;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .image-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 10px;
            }
            
            .image-item img {
                height: 120px;
            }
        }

        /* Card Layout for Search Results */
        .result-card {
            background: #fff;
            color: #333;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            /* Adjust width to fit content but max out at screen width */
            display: inline-block;
            width: 100%; /* Default to full width for consistency */
            max-width: 100%;
            vertical-align: top;
        }

        /* Responsive adjustment: Allow card to shrink if needed, or stay full width */
        @media (min-width: 769px) {
            .result-card {
                 width: fit-content;
                 min-width: 300px;
                 max-width: 100%;
                 display: block; /* Stack them */
            }
        }
        
        /* Mobile: full width is usually best, but user asked for "fit width" */
        /* If we use fit-content on mobile, and data is short, it looks weird if left aligned. */
        /* Let's try to follow user instruction strictly: "不無條件填滿" */
        
        .result-card {
            width: fit-content;
            min-width: 300px; /* Prevent too narrow */
            max-width: 100%;
            display: block; /* Keep them stacked */
        }
        
        .card-header {
            background: #3f51b5; /* Matches accent color */
            color: #fff;
            padding: 10px 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-body {
            padding: 0;
        }
        
        .info-row {
            display: flex;
            border-bottom: 1px solid #eee;
            padding: 12px 15px;
            align-items: center;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            width: 120px; /* Fixed width for labels */
            font-weight: bold;
            color: #555;
            flex-shrink: 0;
            font-size: 1rem;
        }
        
        .info-value {
            flex-grow: 1;
            color: #222;
            font-size: 1rem;
            word-break: break-word;
        }

        .info-value[contenteditable="true"] {
            border: 1px dashed #999;
            padding: 4px;
            background: #fffde7;
            min-height: 20px;
        }
        
        .hidden-empty-row {
            display: none !important;
        }
        
        .highlight-bg {
            background-color: #ffeb3b; /* Yellow highlight */
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .card-actions {
            padding: 10px 15px;
            background: #f5f5f5;
            border-top: 1px solid #eee;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Smaller buttons in result cards */
        .card-actions button {
            padding: 4px 8px;
            font-size: 0.8rem;
            margin: 0;
        }
        
        /* Dark mode adjustments for cards if needed, but screenshot shows white cards */
        /* Keeping white cards as requested/shown in screenshot */

        /* Modification Record Page Styles */
        #modRecordPage {
            /* Inherits container styles */
            z-index: 100;
        }
        .mod-log-card {
            background: #fff;
            color: #333;
            border-radius: 8px;
            padding: 6px; /* Reduced padding further */
            margin-bottom: 6px; /* Reduced margin */
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }
        .mod-log-header {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
            padding-bottom: 2px;
            margin-bottom: 2px;
            font-weight: bold;
            color: #555;
            font-size: 0.8rem; /* Smaller header font */
        }
        .mod-log-content {
            /* white-space: pre-wrap; handled in inner div */
            /* line-height: 1.4; handled in inner div */
            /* font-size: 0.9em; handled in inner div */
        }
        .mod-log-time {
            font-size: 0.75rem;
            color: #888;
        }

        /* Mod Record Page Styles */
        #modRecordPage {
            display: flex;
            flex-direction: column;
            height: 100%; /* Ensure it takes full height of container */
            overflow: hidden; /* Prevent outer scroll */
        }
        
        .mod-nav {
            flex-shrink: 0; /* Don't shrink */
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        .mod-nav > div {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #modRecordList {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px; /* Space for scrollbar */
        }

        .mod-cat-btn {
            padding: 4px 10px; /* Smaller padding */
            font-size: 0.85rem; /* Smaller font */
            border-radius: 4px;
            border: none;
            cursor: pointer;
            color: #fff; /* Default text color */
            transition: opacity 0.2s;
            margin: 0 4px; /* Reduced spacing */
        }
        .mod-cat-btn:hover { opacity: 0.8; }
        
        /* Specific Colors for Mod Buttons */
        .btn-phones { background-color: #FBC02D; color: #000; } /* Yellow */
        .btn-dispatch { background-color: #2196F3; } /* Blue */
        .btn-images { background-color: #4CAF50; } /* Green */
        .btn-search { background-color: #FF9800; } /* Orange */

        /* Back to Top Button */
        #backToTop {
            position: fixed;
            bottom: 40px; /* Above footer */
            right: 20px;
            background: rgba(63, 81, 181, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            display: none; /* Hidden by default */
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transition: opacity 0.3s, background 0.3s;
            justify-content: center;
            align-items: center;
        }
        #backToTop:hover {
            background: rgba(63, 81, 181, 1);
        }
        
        /* Footer Status */
        #footerStatus {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            padding: 5px 0;
            font-size: 0.8rem;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }
        
        /* Search Count Style */
        .search-count {
            font-size: 0.75rem;
            color: #aaa;
            margin-bottom: 2px;
            margin-left: 2px;
        }

    </style>
</head>
<body>

<!-- Login Overlay (Initially Hidden) -->
<div id="loginOverlay" class="login-overlay hidden">
    <div class="login-box">
        <span class="close-btn" onclick="hideLoginModal()">X</span>
        <h2>請選擇身分登入</h2>
        
        <div id="identity-selection">
            <button onclick="selectIdentity('colleague')" class="identity-btn" style="background: linear-gradient(135deg, #2196F3, #1976D2); width: 100%; margin: 10px 0; padding: 12px; font-size: 1.1rem;">
                同仁登入
            </button>
            <button onclick="selectIdentity('admin')" class="identity-btn" style="background: linear-gradient(135deg, #FF9800, #F57C00); width: 100%; margin: 10px 0; padding: 12px; font-size: 1.1rem;">
                管理登入
            </button>
        </div>

        <div id="password-section" class="hidden">
            <h3 id="selected-identity-title" style="margin: 10px 0; color: #aaa;"></h3>
            <input type="password" id="password" placeholder="請輸入密碼" onkeypress="if(event.key === 'Enter') handleLogin()">
            <br>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
                <button onclick="handleLogin()" style="flex: 1;">確認</button>
                <button onclick="resetIdentity()" style="background: #757575; flex: 1;">返回</button>
            </div>
            <p id="loginError" style="color: red; display: none; margin-top: 10px;">密碼錯誤</p>
        </div>
    </div>
</div>

<!-- Add Phone Modal -->
<div id="addPhoneModal" class="login-overlay hidden">
    <div class="login-box" style="max-width: 500px; text-align: left;">
        <span class="close-btn" onclick="hideAddPhoneModal()">X</span>
        <h2 style="text-align: center; margin-bottom: 20px;">新增分機資料</h2>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
                <label style="font-size: 0.8rem; color: #aaa;">分機號碼 *</label>
                <input type="text" id="add-extension" placeholder="必填">
            </div>
            <div>
                <label style="font-size: 0.8rem; color: #aaa;">LENS *</label>
                <input type="text" id="add-lens" placeholder="必填">
            </div>
            <div>
                <label style="font-size: 0.8rem; color: #aaa;">使用單位</label>
                <input type="text" id="add-unit">
            </div>
            <div>
                <label style="font-size: 0.8rem; color: #aaa;">線組編號</label>
                <input type="text" id="add-line_group_id">
            </div>
            <div>
                <label style="font-size: 0.8rem; color: #aaa;">UG50</label>
                <input type="text" id="add-UG50_port">
            </div>
            <div>
                <label style="font-size: 0.8rem; color: #aaa;">分機種類</label>
                <input type="text" id="add-type">
            </div>
            <div>
                <label style="font-size: 0.8rem; color: #aaa;">DID號碼</label>
                <input type="text" id="add-did_number">
            </div>
             <div>
                <label style="font-size: 0.8rem; color: #aaa;">裝機位置</label>
                <input type="text" id="add-location">
            </div>
             <div>
                <label style="font-size: 0.8rem; color: #aaa;">MDF</label>
                <input type="text" id="add-mdf_port">
            </div>
             <div>
                <label style="font-size: 0.8rem; color: #aaa;">MC-ID</label>
                <input type="text" id="add-remote_mc_id">
            </div>
        </div>
        <div style="margin-top: 10px;">
            <label style="font-size: 0.8rem; color: #aaa;">備註</label>
            <input type="text" id="add-note" style="width: 95%;">
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button onclick="submitAddPhone()" style="width: 100%; padding: 10px; font-size: 1.1rem;">確認新增</button>
        </div>
    </div>
</div>

<div id="addDispatchModal" class="login-overlay hidden">
    <div class="login-box" style="max-width: 500px; text-align: left;">
        <span class="close-btn" onclick="hideAddDispatchModal()">X</span>
        <h2 style="text-align: center; margin-bottom: 20px;">新增調度電話</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
                <label style="font-size: 0.8rem; color: #aaa;">分機號碼 *</label>
                <input type="text" id="add-dispatch-extension" placeholder="必填">
            </div>
            <div>
                <label style="font-size: 0.8rem; color: #aaa;">C端子位置</label>
                <input type="text" id="add-dispatch-c_terminal">
            </div>
            <div>
                <label style="font-size: 0.8rem; color: #aaa;">LENS</label>
                <input type="text" id="add-dispatch-lens">
            </div>
            <div>
                <label style="font-size: 0.8rem; color: #aaa;">線組編號(機房)</label>
                <input type="text" id="add-dispatch-line_group_room">
            </div>
            <div>
                <label style="font-size: 0.8rem; color: #aaa;">線組編號(現場)</label>
                <input type="text" id="add-dispatch-line_group_site">
            </div>
            <div>
                <label style="font-size: 0.8rem; color: #aaa;">使用單位</label>
                <input type="text" id="add-dispatch-unit">
            </div>
            <div>
                <label style="font-size: 0.8rem; color: #aaa;">裝機位置</label>
                <input type="text" id="add-dispatch-location">
            </div>
            <div>
                <label style="font-size: 0.8rem; color: #aaa;">副機數量</label>
                <input type="text" id="add-dispatch-sub_count">
            </div>
            <div>
                <label style="font-size: 0.8rem; color: #aaa;">連絡電話</label>
                <input type="text" id="add-dispatch-contact_tel">
            </div>
        </div>
        <div style="text-align: center; margin-top: 20px;">
            <button onclick="submitAddDispatch()" style="width: 100%; padding: 10px; font-size: 1.1rem;">確認新增</button>
        </div>
    </div>
</div>

<div class="container" id="mainApp">
    <div id="globalError" style="display:none; background: #ffebee; color: #c62828; padding: 10px; margin-bottom: 10px; border: 1px solid #ef9a9a; border-radius: 4px;"></div>
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>資料查詢系統</h1>
        <div>
            <!-- Modification Record Button -->
            <button id="modRecordBtn" onclick="showModRecordPage()" style="background: #4CAF50; color: #FFEB3B; margin-right: 10px; font-size: 0.75rem; padding: 4px 8px;">修改紀錄</button>
            <!-- Login Button (Visible when logged out) -->
            <button id="loginBtn" onclick="showLoginModal()">登入修改</button>
            
            <!-- User Info & Logout (Visible when logged in) -->
            <span id="userControls" class="hidden">
                <!-- User Info moved to footer -->
                <button onclick="logout()" style="background: #CD5C5C;">登出</button>
            </span>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active tab-phones" onclick="switchTab('phones', this)">分機資料</div>
        <div class="tab tab-dispatch" onclick="switchTab('dispatch', this)">調度電話</div>
        <div class="tab tab-images" onclick="switchTab('images', this)">PA天車資料</div>
    </div>

    <!-- Phones Section -->
    <div id="phonesSection" class="section">
        <div class="toolbar">
            <div class="search-group" style="flex-wrap: wrap;">
                <div id="phoneSearchCount" class="search-count" style="width: 100%;"></div>
                <input type="text" id="phoneSearch" placeholder="搜尋分機..." style="width: 150px;">
                <button onclick="searchPhones()">搜尋</button>
                <button class="btn-clear" onclick="clearInput('phoneSearch')">清除</button>
                <button id="btnAddPhone" onclick="showAddPhoneModal()" style="background: #009688;" class="hidden">新增</button>
            </div>
            
            <!-- Auth Only Controls -->
            <div id="phoneAuthControls" class="hidden">
                <button onclick="exportToExcel('phones')" style="background: #20B2AA;">匯出 Excel</button>
                <button onclick="document.getElementById('phoneImport').click()" style="background: #DAA520;">匯入 Excel</button>
                <input type="file" id="phoneImport" accept=".xlsx" style="display: none;" onchange="importExcel('phones', this)">
                <button id="btn-clearPhones" onclick="deleteAllPhones()" style="background: #CD5C5C; margin-left: 10px;" class="hidden">清空資料</button>
            </div>
        </div>
        <div id="phonesTableContainer"></div>
    </div>

    <!-- Dispatch Section -->
    <div id="dispatchSection" class="section hidden">
        <div class="toolbar">
            <div class="search-group" style="flex-wrap: wrap;">
                <div id="dispatchSearchCount" class="search-count" style="width: 100%;"></div>
                <input type="text" id="dispatchSearch" placeholder="搜尋調度電話..." style="width: 150px;">
                <button onclick="searchDispatch()">搜尋</button>
                <button class="btn-clear" onclick="clearInput('dispatchSearch')">清除</button>
                <button id="btnAddDispatch" onclick="showAddDispatchModal()" style="background: #009688;" class="hidden">新增</button>
            </div>
            
            <!-- Auth Only Controls -->
            <div id="dispatchAuthControls" class="hidden">
                <button onclick="exportToExcel('dispatch')" style="background: #20B2AA;">匯出 Excel</button>
                <button onclick="document.getElementById('dispatchImport').click()" style="background: #DAA520;">匯入 Excel</button>
                <input type="file" id="dispatchImport" accept=".xlsx" style="display: none;" onchange="importExcel('dispatch', this)">
                <button id="btn-clearDispatch" onclick="deleteAllDispatch()" style="background: #CD5C5C; margin-left: 10px;" class="hidden">清空資料</button>
            </div>
        </div>
        <div id="dispatchTableContainer"></div>
    </div>

    <!-- Images Section -->
    <div id="imagesSection" class="section hidden">
        <div class="toolbar">
            <div class="search-group" style="flex-wrap: wrap;">
                <div id="imgSearchCount" class="search-count" style="width: 100%;"></div>
                <input type="text" id="imgSearch" placeholder="搜尋PA天車資料..." style="width: 300px;">
                <button onclick="searchImages()">搜尋</button>
                <button onclick="searchLatestImages()" style="background-color: #008CBA;">最新圖片</button>
                <button class="btn-clear" onclick="clearInput('imgSearch')">清除</button>
            </div>
            
            <!-- Auth Only Controls -->
            <div id="imgAuthControls" class="hidden">
                <button onclick="document.getElementById('imgUploadInput').click()" style="background: #228B22;">+ 上傳圖片</button>
                <input type="file" id="imgUploadInput" multiple accept="image/*,.xls,.xlsx,.pdf" style="display: none;" onchange="handleImageUpload(this)">
                <div style="font-size: 12px; color: #aaa; margin-top: 5px;">* 支援 Excel 表格與 PDF 文件 (Word/PPT 請先轉存 PDF)</div>
            </div>
        </div>
        <div id="imageGrid" class="image-grid"></div>
    </div>


</div>

<!-- Modification Record Page -->
<div id="modRecordPage" class="container hidden">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-shrink: 0;">
        <h1>修改紀錄</h1>
        <button onclick="hideModRecordPage()" style="background: #757575;">返回查詢</button>
    </div>

    <div class="mod-nav">
        <div style="display: inline-block; text-align: center; margin: 0 5px;">
            <button class="mod-cat-btn btn-phones" data-table="phones" onclick="loadModRecords('phones')">分機修改紀錄</button>
            <div id="lastModTime-phones" style="color: #bbb; font-size: 0.75rem;">最新: 讀取中...</div>
        </div>
        <div style="display: inline-block; text-align: center; margin: 0 5px;">
            <button class="mod-cat-btn btn-dispatch" data-table="dispatch_phones" onclick="loadModRecords('dispatch_phones')">調度修改紀錄</button>
            <div id="lastModTime-dispatch_phones" style="color: #bbb; font-size: 0.75rem;">最新: 讀取中...</div>
        </div>
        <div style="display: inline-block; text-align: center; margin: 0 5px;">
            <button class="mod-cat-btn btn-images" data-table="images" onclick="loadModRecords('images')">PA天車修改紀錄</button>
            <div id="lastModTime-images" style="color: #bbb; font-size: 0.75rem;">最新: 讀取中...</div>
        </div>
        <div id="searchLogContainer" class="hidden" style="display: inline-block; text-align: center; margin: 0 5px;">
            <button class="mod-cat-btn btn-search" data-table="search_logs" onclick="loadModRecords('search_logs')">使用者查詢紀錄</button>
            <div style="color: #bbb; font-size: 0.75rem;">(管理者專用)</div>
        </div>
    </div>

    <div id="modRecordList">
        <p style="text-align: center; color: #888; margin-top: 20px;">請選擇上方類別查看紀錄</p>
    </div>
</div>

<button id="backToTop" title="回到最上方">▲</button>
<div id="footerStatus" class="hidden"></div>

<script>
    // ==========================================
    // CONFIGURATION
    // ==========================================
    const SUPABASE_URL = 'https://uelrewmkmderacsqqkpk.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_LOi6vuzP3h-T14-43ujocQ_gjJpsToT';
    // ==========================================
    
    // Global Error Handler for user feedback
    window.onerror = function(msg, url, line, col, error) {
        const errDiv = document.getElementById('globalError');
        if (errDiv) {
            errDiv.style.display = 'block';
            errDiv.innerHTML += `<div>${msg} (Line ${line})</div>`;
        }
        return false;
    };

    let supabaseClient = null;

    // Initialize Supabase safely
    try {
        if (window.supabase) {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } else {
            console.error('Supabase library not loaded (window.supabase is undefined)');
        }
    } catch (e) {
        console.error('Supabase initialization failed:', e);
    }

    if (!supabaseClient) {
        setTimeout(() => {
             const errDiv = document.getElementById('globalError');
             if (errDiv) {
                 errDiv.style.display = 'block';
                 errDiv.innerHTML += `<div>錯誤：無法載入 Supabase 系統元件。請確認網路連線。</div>`;
             }
        }, 2000);
    }

    let currentUser = null;
    let phoneData = [];
    let dispatchData = [];

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
        // Back to Top Logic (Updated for internal scrolling)
        const backToTopBtn = document.getElementById('backToTop');
        const scrollContainers = [
            document.getElementById('phonesTableContainer'),
            document.getElementById('dispatchTableContainer'),
            document.getElementById('imageGrid'),
            document.getElementById('modRecordList')
        ];

        function handleScroll(e) {
            if (e.target.scrollTop > 300) {
                backToTopBtn.style.display = 'flex';
            } else {
                backToTopBtn.style.display = 'none';
            }
        }

        scrollContainers.forEach(container => {
            if(container) container.addEventListener('scroll', handleScroll);
        });

        backToTopBtn.addEventListener('click', () => {
            scrollContainers.forEach(container => {
                if (container && container.offsetParent !== null) { // Check visibility
                    container.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });
        });
        
        // Long Press Logic for Mod Record Category Buttons
        const modCatBtns = document.querySelectorAll('.mod-cat-btn');
        modCatBtns.forEach(btn => {
            let pressTimer;
            const startPress = () => {
                pressTimer = setTimeout(() => {
                    const table = btn.dataset.table;
                    clearAllModLogs(table);
                }, 1000); // 1 second long press
            };
            const cancelPress = () => {
                clearTimeout(pressTimer);
            };
            
            // Mouse
            btn.addEventListener('mousedown', startPress);
            btn.addEventListener('mouseup', cancelPress);
            btn.addEventListener('mouseleave', cancelPress);
            
            // Touch
            btn.addEventListener('touchstart', startPress);
            btn.addEventListener('touchend', cancelPress);
            btn.addEventListener('touchcancel', cancelPress);
        });

        // if (supabaseClient) {
        //     loadInitialData(); // Removed as per user request: "Show data only after search"
        // }
        
        // Force UI State Update to ensure buttons are correctly set
        updateUIState();
        
        // Initial empty state message
        document.getElementById('imageGrid').innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #888; padding: 20px;">請輸入關鍵字搜尋PA天車資料</div>';
        document.getElementById('phonesTableContainer').innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">請輸入關鍵字搜尋分機</div>';
        document.getElementById('dispatchTableContainer').innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">請輸入關鍵字搜尋調度電話</div>';
        
        // Attach event listeners explicitly if inline onclick fails
        document.getElementById('imgSearch').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') searchImages();
        });
        document.getElementById('phoneSearch').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') searchPhones();
        });
         document.getElementById('dispatchSearch').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') searchDispatch();
        });
    });

    function showLoginModal() {
        document.getElementById('loginOverlay').classList.remove('hidden');
        document.getElementById('loginError').style.display = 'none';
        document.getElementById('password').value = '';
        setTimeout(() => document.getElementById('password').focus(), 100);
    }

    function hideLoginModal() {
        document.getElementById('loginOverlay').classList.add('hidden');
    }

    function clearInput(id) {
        document.getElementById(id).value = '';
        document.getElementById(id).focus();
        
        // Clear results based on input ID and restore initial message
        if (id === 'imgSearch') {
            document.getElementById('imageGrid').innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #888; padding: 20px;">請輸入關鍵字搜尋PA天車資料</div>';
            document.getElementById('imgSearchCount').innerText = '';
        } else if (id === 'phoneSearch') {
            document.getElementById('phonesTableContainer').innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">請輸入關鍵字搜尋分機</div>';
            document.getElementById('phoneSearchCount').innerText = '';
        } else if (id === 'dispatchSearch') {
            document.getElementById('dispatchTableContainer').innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">請輸入關鍵字搜尋調度電話</div>';
            document.getElementById('dispatchSearchCount').innerText = '';
        }
    }

    // Login Logic
    let selectedRole = null;

    function showLoginModal() {
        document.getElementById('loginOverlay').classList.remove('hidden');
        resetIdentity();
    }

    function hideLoginModal() {
        document.getElementById('loginOverlay').classList.add('hidden');
    }

    function selectIdentity(role) {
        selectedRole = role;
        document.getElementById('identity-selection').classList.add('hidden');
        document.getElementById('password-section').classList.remove('hidden');
        
        const title = role === 'admin' ? '管理者登入' : '同仁登入';
        document.getElementById('selected-identity-title').innerText = title;
        
        document.getElementById('loginError').style.display = 'none';
        document.getElementById('password').value = '';
        setTimeout(() => document.getElementById('password').focus(), 100);
    }

    function resetIdentity() {
        selectedRole = null;
        document.getElementById('identity-selection').classList.remove('hidden');
        document.getElementById('password-section').classList.add('hidden');
        document.getElementById('password').value = '';
        document.getElementById('loginError').style.display = 'none';
    }

    async function handleLogin() {
        if (!supabaseClient) { alert('系統未連線，無法登入'); return; }
        
        const pass = document.getElementById('password').value;
        
        // Hardcoded Password Check
        let isValid = false;
        let userData = null;

        if (selectedRole === 'colleague') {
            if (pass === 'w513w513') {
                isValid = true;
                userData = {
                    id: 'colleague_user',
                    username: '同仁',
                    role: 'user',
                    group_id: 1
                };
            }
        } else if (selectedRole === 'admin') {
            if (pass === '122232') {
                isValid = true;
                userData = {
                    id: 'admin_user',
                    username: '管理者',
                    role: 'admin',
                    group_id: 1
                };
            }
        }

        if (isValid && userData) {
            currentUser = userData;
            hideLoginModal();
            updateUIState();
        } else {
            document.getElementById('loginError').style.display = 'block';
        }
    }

    function logout() {
        currentUser = null;
        updateUIState();
        
        // Security: Re-render views to hide sensitive actions immediately
        if (document.getElementById('phoneSearch').value) searchPhones();
        if (document.getElementById('dispatchSearch').value) searchDispatch();
        // For images, we must re-render to remove edit buttons/pencil icons
        if (document.getElementById('imgSearch').value) {
            searchImages();
        } else {
            // If no search, ensure grid is clean or default state (though it should be fine)
             document.getElementById('imageGrid').innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #888; padding: 20px;">請輸入關鍵字搜尋PA天車資料</div>';
        }
    }

    // ================= ADD PHONE LOGIC =================
    function showAddPhoneModal() {
        if (!currentUser) { alert('請先登入'); showLoginModal(); return; }
        document.getElementById('addPhoneModal').classList.remove('hidden');
        // Clear inputs
        const inputs = document.querySelectorAll('#addPhoneModal input');
        inputs.forEach(input => input.value = '');
    }

    function hideAddPhoneModal() {
        document.getElementById('addPhoneModal').classList.add('hidden');
    }

    async function submitAddPhone() {
        if (!supabaseClient) return;
        
        const extension = document.getElementById('add-extension').value.trim();
        const lens = document.getElementById('add-lens').value.trim();
        const unit = document.getElementById('add-unit').value.trim();
        const line_group_id = document.getElementById('add-line_group_id').value.trim();
        const UG50_port = document.getElementById('add-UG50_port').value.trim();
        const type = document.getElementById('add-type').value.trim();
        const did_number = document.getElementById('add-did_number').value.trim();
        const location = document.getElementById('add-location').value.trim();
        const mdf_port = document.getElementById('add-mdf_port').value.trim();
        const remote_mc_id = document.getElementById('add-remote_mc_id').value.trim();
        const note = document.getElementById('add-note').value.trim();

        if (!extension || !lens) {
            alert('分機號碼與 LENS 為必填欄位');
            return;
        }

        // Check Duplicates
        // Logic: Check if extension OR lens exists in DB
        try {
            const { data: existing, error: checkError } = await supabaseClient
                .from('phones')
                .select('extension, lens')
                .or(`extension.eq.${extension},lens.eq.${lens}`);

            if (checkError) throw checkError;

            if (existing && existing.length > 0) {
                const dupExt = existing.find(x => x.extension === extension);
                const dupLens = existing.find(x => x.lens === lens);
                
                let msg = '無法新增：\n';
                if (dupExt) msg += `- 分機號碼 ${extension} 已存在\n`;
                if (dupLens) msg += `- LENS ${lens} 已存在\n`;
                alert(msg);
                return;
            }

            // Insert
            const newRecord = {
                extension, lens, unit, line_group_id, UG50_port, 
                type, did_number, location, mdf_port, remote_mc_id, note
            };

            const { data: inserted, error: insertError } = await supabaseClient
                .from('phones')
                .insert(newRecord)
                .select()
                .single();

            if (insertError) throw insertError;

            alert('新增成功');
            hideAddPhoneModal();
            
            // Log
            await logModification('phones', 'INSERT', inserted.id, `新增分機: ${extension}`, null, newRecord);
            
            // Notification
            const time = new Date().toLocaleString();
            sendTelegramNotification(`<b>資料新增通知 (分機)</b>\n用戶: ${currentUser.username}\n時間: ${time}\n分機: ${extension}\nLENS: ${lens}`);

            // Refresh
            searchPhones();

        } catch (e) {
            console.error(e);
            alert('新增失敗: ' + e.message);
        }
    }

    function showAddDispatchModal() {
        if (!currentUser) { alert('請先登入'); showLoginModal(); return; }
        document.getElementById('addDispatchModal').classList.remove('hidden');
        // Clear inputs
        const inputs = document.querySelectorAll('#addDispatchModal input');
        inputs.forEach(input => input.value = '');
    }

    function hideAddDispatchModal() {
        document.getElementById('addDispatchModal').classList.add('hidden');
    }

    async function submitAddDispatch() {
        if (!supabaseClient) return;
        
        const extension = document.getElementById('add-dispatch-extension').value.trim();
        const c_terminal = document.getElementById('add-dispatch-c_terminal').value.trim();
        const lens = document.getElementById('add-dispatch-lens').value.trim();
        const line_group_room = document.getElementById('add-dispatch-line_group_room').value.trim();
        const line_group_site = document.getElementById('add-dispatch-line_group_site').value.trim();
        const unit = document.getElementById('add-dispatch-unit').value.trim();
        const location = document.getElementById('add-dispatch-location').value.trim();
        const sub_count = document.getElementById('add-dispatch-sub_count').value.trim();
        const contact_tel = document.getElementById('add-dispatch-contact_tel').value.trim();

        if (!extension) {
            alert('分機號碼為必填欄位');
            return;
        }

        // Check Duplicates
        try {
            const { data: existing, error: checkError } = await supabaseClient
                .from('dispatch_phones')
                .select('extension')
                .eq('extension', extension);

            if (checkError) throw checkError;

            if (existing && existing.length > 0) {
                alert(`無法新增：分機號碼 ${extension} 已存在`);
                return;
            }

            // Insert
            const newRecord = {
                extension, c_terminal, lens, line_group_room, line_group_site,
                unit, location, sub_count, contact_tel
            };

            const { data: inserted, error: insertError } = await supabaseClient
                .from('dispatch_phones')
                .insert(newRecord)
                .select()
                .single();

            if (insertError) throw insertError;

            alert('新增成功');
            hideAddDispatchModal();
            
            // Log
            await logModification('dispatch_phones', 'INSERT', inserted.id, `新增調度電話: ${extension}`, null, newRecord);
            
            // Notification
            const time = new Date().toLocaleString();
            sendTelegramNotification(`<b>資料新增通知 (調度)</b>\n用戶: ${currentUser.username}\n時間: ${time}\n分機: ${extension}\nLENS: ${lens}`);

            // Refresh
            searchDispatch();

        } catch (e) {
            console.error(e);
            alert('新增失敗: ' + e.message);
        }
    }

    function getRoleName(role) {
        return role === 'admin' ? '管理員' : '一般用戶';
    }

    function updateUIState() {
        const isLoggedIn = !!currentUser;
        
        // Header Buttons
        if (isLoggedIn) {
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('userControls').classList.remove('hidden');
            
            // Footer Status
            const footer = document.getElementById('footerStatus');
            footer.textContent = `已登入: ${currentUser.username} (${getRoleName(currentUser.role)})`;
            footer.classList.remove('hidden');
        } else {
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('userControls').classList.add('hidden');
            
            // Hide Footer
            document.getElementById('footerStatus').classList.add('hidden');
        }

        // Auth Controls (Upload/Import/Export)
        const authControls = ['imgAuthControls', 'phoneAuthControls', 'dispatchAuthControls'];
        authControls.forEach(id => {
            if (isLoggedIn) document.getElementById(id).classList.remove('hidden');
            else document.getElementById(id).classList.add('hidden');
        });

        // Add Buttons (Phone/Dispatch)
        const addButtons = ['btnAddPhone', 'btnAddDispatch'];
        addButtons.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                if (isLoggedIn) el.classList.remove('hidden');
                else el.classList.add('hidden');
            }
        });



        // Admin Only Controls
        const adminControls = ['btn-clearPhones', 'btn-clearDispatch'];
        adminControls.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                if (isLoggedIn && currentUser.role === 'admin') el.classList.remove('hidden');
                else el.classList.add('hidden');
            }
        });

        // Re-render tables to update contenteditable and delete buttons
        // Only if data exists (to avoid clearing tables on simple logout)
        if (phoneData.length > 0) renderPhoneTable(phoneData);
        if (dispatchData.length > 0) renderDispatchTable(dispatchData);
        // searchImages(); // Removed to prevent auto-loading
    }

    // ================= TELEGRAM NOTIFICATION =================
    async function sendTelegramNotification(message) {
        if (!supabaseClient) return;
        try {
            // Call the secure database function
            await supabaseClient.rpc('send_telegram_notification', { 
                message_text: message 
            });
        } catch (e) {
            console.error('Failed to send notification', e);
        }
    }



    function switchTab(tabName, clickedElement) {
        document.getElementById('backToTop').style.display = 'none'; // Hide back to top button on switch
        document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
        document.getElementById(tabName + 'Section').classList.remove('hidden');
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        // If clickedElement is provided, use it; otherwise find by text or index (fallback)
        if (clickedElement) {
            clickedElement.classList.add('active');
        } else if (event && event.target) {
             event.target.classList.add('active');
        }
    }

    async function loadInitialData() {
        searchImages();
        searchPhones();
        searchDispatch();
    }

    function toggleMore(id, count) {
        const el = document.getElementById(id);
        const btn = document.getElementById('btn-' + id);
        if (el.classList.contains('hidden')) {
            el.classList.remove('hidden');
            btn.innerText = '隱藏其餘結果';
        } else {
            el.classList.add('hidden');
            btn.innerText = `顯示其餘 ${count} 筆結果`;
        }
    }

    // ================= IMAGES =================
    async function searchImages() {
        const query = document.getElementById('imgSearch').value;
        const countEl = document.getElementById('imgSearchCount');
        countEl.innerText = '';

        
        let dbQuery = supabaseClient.from('images').select('*');
        
        if (query) {
            dbQuery = dbQuery.ilike('filename', `%${query}%`);
        }
        
        const { data, error } = await dbQuery;
        if (error) { console.error('Error loading images', error); return; }

        // Log Search
        if (query && currentUser) {
             logModification('search_logs', 'SEARCH', null, `搜尋圖片: ${query}`, null, null).catch(e => console.error('Log search error:', e));
        }

        if (data) countEl.innerText = `搜尋結果: ${data.length} 筆`;
        renderImages(data);
    }


    async function searchLatestImages() {
        const date = new Date();
        date.setDate(date.getDate() - 30);
        const countEl = document.getElementById('imgSearchCount');
        countEl.innerText = '';
        
        const { data, error } = await supabaseClient
            .from('images')
            .select('*')
            .gte('created_at', date.toISOString())
            .order('created_at', { ascending: false });
            
        if (error) { console.error('Error loading latest images', error); alert('載入失敗'); return; }
        if (data) countEl.innerText = `最新圖片: ${data.length} 筆`;
        renderImages(data);
    }

    function renderImages(data) {
        const grid = document.getElementById('imageGrid');
        grid.innerHTML = '';
        
        if (!data || data.length === 0) {
            grid.innerHTML = '<div style="width:100%; text-align:center; color:#666; padding:20px;">無符合圖片</div>';
            return;
        }

        data.forEach(img => {
            const div = document.createElement('div');
            div.className = 'image-item';
            // Construct Public URL
            const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/images/${img.file_path}`;
            
            let deleteBtn = '';
            if (currentUser && currentUser.role === 'admin') {
                const safeFilename = (img.filename || '').replace(/'/g, "\\'");
                deleteBtn = `<div style="margin-top:5px;"><button onclick="deleteImage('${img.id}', '${img.file_path}', '${safeFilename}')" style="background:#ff4444;color:white;border:none;padding:5px 10px;cursor:pointer;border-radius:3px;">刪除</button></div>`;
            }

            // Name Display / Edit Logic
            let nameHtml = `<div style="margin-top:5px; word-break:break-all;">${img.filename}</div>`;
            
            if (currentUser) {
                const safeName = (img.filename || '').replace(/"/g, '&quot;');
                nameHtml = `
                <div class="img-name-container" style="margin-top:5px;">
                    <div id="name-display-${img.id}" style="display:flex; justify-content:center; align-items:center; gap:5px;">
                        <span style="word-break:break-all;">${img.filename}</span>
                        <button onclick="enableImageEdit('${img.id}')" style="background:none; border:none; cursor:pointer; opacity:0.6;" title="修改名稱">✏️</button>
                    </div>
                    <div id="name-edit-${img.id}" style="display:none;">
                        <input type="text" id="input-${img.id}" value="${safeName}" style="width:100%; box-sizing:border-box; padding:4px; margin-bottom:4px; border:1px solid #ccc; border-radius:3px;">
                        <div>
                            <button onclick="saveImageName('${img.id}')" style="background:#4caf50; color:white; border:none; padding:3px 8px; border-radius:3px; font-size:12px; cursor:pointer;">儲存</button>
                            <button onclick="cancelImageEdit('${img.id}')" style="background:#757575; color:white; border:none; padding:3px 8px; border-radius:3px; font-size:12px; cursor:pointer;">取消</button>
                        </div>
                    </div>
                </div>`;
            }

            div.innerHTML = `
                <img src="${publicUrl}" loading="lazy" onclick="window.open('${publicUrl}')">
                ${nameHtml}
                ${deleteBtn}
            `;
            grid.appendChild(div);
        });

        // Blinking Login Button Effect
        const loginBtn = document.getElementById('loginBtn');
        if (loginBtn) {
            if (!currentUser && data.length > 0) {
                loginBtn.classList.add('blink-orange');
            } else {
                loginBtn.classList.remove('blink-orange');
            }
        }
    }

    function enableImageEdit(id) {
        const display = document.getElementById(`name-display-${id}`);
        const edit = document.getElementById(`name-edit-${id}`);
        if(display) display.style.display = 'none';
        if(edit) edit.style.display = 'block';
    }

    function cancelImageEdit(id) {
        const display = document.getElementById(`name-display-${id}`);
        const edit = document.getElementById(`name-edit-${id}`);
        const input = document.getElementById(`input-${id}`);
        const nameSpan = display ? display.querySelector('span') : null;
        
        if(display) display.style.display = 'flex';
        if(edit) edit.style.display = 'none';
        if(input && nameSpan) input.value = nameSpan.innerText;
    }

    async function saveImageName(id) {
        const input = document.getElementById(`input-${id}`);
        const newName = input.value.trim();
        if (!newName) return alert('名稱不能為空');
        
        const btn = event.target; 
        const originalText = btn.innerText;
        btn.innerText = '...';
        btn.disabled = true;

        const { error } = await supabaseClient
            .from('images')
            .update({ filename: newName })
            .eq('id', id);
            
        btn.innerText = originalText;
        btn.disabled = false;

        if (error) {
            alert('更新失敗: ' + error.message);
        } else {
            const display = document.getElementById(`name-display-${id}`);
            const nameSpan = display.querySelector('span');
            const oldName = nameSpan ? nameSpan.innerText : '(Unknown)';
            if(nameSpan) nameSpan.innerText = newName;
            
            // Log Modification
            await logModification('images', 'UPDATE', id, `圖片更名: ${oldName} -> ${newName}`, {filename: oldName}, {filename: newName});

            const time = new Date().toLocaleString();
            sendTelegramNotification(`<b>圖片名稱修改通知</b>\n用戶: ${currentUser.username}\n時間: ${time}\n舊名稱: ${oldName}\n新名稱: ${newName}`);
            
            cancelImageEdit(id);
        }
    }

    async function handleImageUpload(input) {
        if (!currentUser) return;
        if (!input.files.length) return;
        
        let uploadedFiles = [];

        // Helper to convert blob to file object for uploading
        const blobToFile = (blob, fileName) => {
            return new File([blob], fileName, { type: 'image/png' });
        };

        // Helper to capture element to blob
        const captureElement = async (element) => {
            document.body.appendChild(element);
            try {
                const canvas = await html2canvas(element, {
                    backgroundColor: '#ffffff',
                    scale: 2 // Better quality
                });
                return new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
            } finally {
                document.body.removeChild(element);
            }
        };

        for (const file of input.files) {
            let fileToUpload = file;
            let originalName = file.name;
            let fileNameBase = originalName.substring(0, originalName.lastIndexOf('.')) || originalName;
            
            const ext = originalName.split('.').pop().toLowerCase();

            try {
                if (['xls', 'xlsx'].includes(ext)) {
                    // Handle Excel
                    const arrayBuffer = await file.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer);
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const html = XLSX.utils.sheet_to_html(worksheet);
                    
                    const container = document.createElement('div');
                    container.style.position = 'absolute';
                    container.style.left = '-9999px';
                    container.style.top = '0';
                    container.style.background = 'white';
                    container.style.padding = '20px';
                    container.style.width = 'fit-content';
                    container.innerHTML = html;
                    
                    // Style the table for better look
                    const table = container.querySelector('table');
                    if (table) {
                        table.style.borderCollapse = 'collapse';
                        table.style.width = '100%';
                        table.querySelectorAll('td, th').forEach(cell => {
                            cell.style.border = '1px solid black';
                            cell.style.padding = '5px';
                        });
                    }

                    const blob = await captureElement(container);
                    if (blob) {
                        fileToUpload = blobToFile(blob, fileNameBase + '.png');
                        originalName = fileNameBase + '.png'; // Update name for DB
                    }
                } else if (ext === 'pdf') {
                    // Handle PDF
                    const arrayBuffer = await file.arrayBuffer();
                    const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
                    const pdf = await loadingTask.promise;
                    
                    // Iterate through ALL pages
                    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                        const page = await pdf.getPage(pageNum);
                        const scale = 2; // Better quality
                        const viewport = page.getViewport({ scale: scale });
                        
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        
                        await page.render({
                            canvasContext: context,
                            viewport: viewport
                        }).promise;
                        
                        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                        if (blob) {
                            // Suffix filename with page number if multiple pages
                            let pageSuffix = pdf.numPages > 1 ? `_p${pageNum}` : '';
                            let finalName = fileNameBase + pageSuffix + '.png';
                            
                            // Upload immediately for each page
                            const safeName = `${Date.now()}_${Math.random().toString(36).substring(2, 10)}.png`;
                            const groupFolder = `group_${currentUser.group_id}`;
                            const filePath = `${groupFolder}/${safeName}`;
                            
                            const { error: uploadError } = await supabaseClient.storage
                                .from('images')
                                .upload(filePath, blobToFile(blob, finalName));
                                
                            if (uploadError) {
                                console.error(`Failed to upload page ${pageNum}:`, uploadError);
                            } else {
                                // Insert Metadata
                            const { data: newImg, error: uploadDbError } = await supabaseClient.from('images').insert({
                                filename: finalName,
                                file_path: filePath,
                                group_id: currentUser.group_id,
                                uploaded_by: currentUser.id
                            }).select().single();

                            if (!uploadDbError && newImg) {
                                uploadedFiles.push(finalName);
                                // Log Modification
                                await logModification('images', 'INSERT', newImg.id, `上傳圖片 (PDF轉檔): ${finalName}`, null, newImg);
                            }
                            }
                        }
                    }
                    continue; // Skip the standard upload logic at end of loop since we handled it here
                } else if (['doc', 'docx', 'ppt', 'pptx'].includes(ext)) {
                    alert(`不支援 Word/PPT 格式: ${originalName}\n請將檔案另存為 PDF 格式後再上傳。`);
                    continue;
                }
            } catch (err) {
                console.error(`Error converting ${file.name}:`, err);
                // Translate common error messages
                let errorMsg = err.message;
                if (errorMsg.includes("Can't find end of central directory")) {
                    errorMsg = "檔案格式錯誤 (可能是 .doc 格式但副檔名為 .docx，或檔案損毀)";
                }
                alert(`轉換失敗: ${file.name}\n${errorMsg}`);
                continue;
            }

            // Generate Safe Storage Path (ASCII only)
            const uploadExt = originalName.split('.').pop();
            const safeName = `${Date.now()}_${Math.random().toString(36).substring(2, 10)}.${uploadExt}`;
            const groupFolder = `group_${currentUser.group_id}`;
            const filePath = `${groupFolder}/${safeName}`;
            
            // 1. Upload to Storage
            const { error: uploadError } = await supabaseClient.storage
                .from('images')
                .upload(filePath, fileToUpload);
                
            if (uploadError) {
                alert(`上傳失敗: ${originalName}`);
                console.error(uploadError);
                continue;
            }

            // 2. Insert Metadata
            const { data: newImg, error: dbError } = await supabaseClient.from('images').insert({
                filename: originalName, // Display name
                file_path: filePath,
                group_id: currentUser.group_id,
                uploaded_by: currentUser.id
            }).select().single();
            
            if (dbError) {
                console.error(dbError);
            } else {
                uploadedFiles.push(originalName);
                // Log Modification
                await logModification('images', 'INSERT', newImg.id, `上傳圖片: ${originalName}`, null, newImg);
            }
        }
        
        if (uploadedFiles.length > 0) {
            const time = new Date().toLocaleString();
            sendTelegramNotification(`<b>圖片上傳通知</b>\n用戶: ${currentUser.username}\n時間: ${time}\n上傳檔案:\n${uploadedFiles.join('\n')}`);
        }

        alert('上傳完成');
        searchImages();
    }

    async function deleteImage(id, filePath, filename) {
        if (!currentUser || currentUser.role !== 'admin') return;
        if (!confirm('確定刪除此圖片?')) return;

        // Fetch full record for logging
        const { data: imgData } = await supabaseClient.from('images').select('*').eq('id', id).single();

        // 1. Delete from Storage
        const { error: storageError } = await supabaseClient.storage
            .from('images')
            .remove([filePath]);

        if (storageError) {
            console.error('Storage delete error:', storageError);
            alert('圖片檔案刪除失敗: ' + storageError.message);
            return;
        }

        // 2. Delete from DB
        const { error: dbError } = await supabaseClient
            .from('images')
            .delete()
            .eq('id', id);

        if (dbError) {
            console.error('DB delete error:', dbError);
            alert('資料庫刪除失敗');
        } else {
            // Log Modification
            await logModification('images', 'DELETE', id, `刪除圖片: ${filename || filePath}`, imgData, null);

            const time = new Date().toLocaleString();
            sendTelegramNotification(`<b>圖片刪除通知</b>\n用戶: ${currentUser.username}\n時間: ${time}\n刪除檔案: ${filename || filePath}`);
            searchImages();
        }
    }

    // Helper to fetch ALL records with pagination loop
    async function fetchAllRecords(tableName) {
        let allData = [];
        let from = 0;
        const limit = 1000;
        let hasMore = true;

        while (hasMore) {
            const { data, error } = await supabaseClient
                .from(tableName)
                .select('*')
                .range(from, from + limit - 1)
                .order('extension');
            
            if (error) {
                console.error(`Error fetching ${tableName}:`, error);
                throw error;
            }

            if (data && data.length > 0) {
                allData = allData.concat(data);
                from += limit;
                if (data.length < limit) hasMore = false;
            } else {
                hasMore = false;
            }
        }
        return allData;
    }

    // Helper to generate OR filter string
    function buildOrFilter(query, columns) {
        return columns.map(col => `${col}.ilike.%${query}%`).join(',');
    }

    // ================= PHONES =================
    // phoneData is declared globally above
    async function searchPhones() {
        if (!supabaseClient) return;
        const query = document.getElementById('phoneSearch').value.trim();
        const countEl = document.getElementById('phoneSearchCount');
        countEl.innerText = '';


        const container = document.getElementById('phonesTableContainer');
        container.innerHTML = '<div style="text-align:center; padding: 20px;">載入中...</div>';

        try {
            let dbQuery = supabaseClient.from('phones').select('*').limit(1000).order('extension');
            
            if (query) {
                // Use correct DB column names
                // Note: 'UG50_port' is the actual column name in DB (verified via check_schema.js)
                const columns = [
                    'extension', 'type', 'lens', 'mdf_port', 
                    'remote_mc_id', 'UG50_port', 'line_group_id', 
                    'unit', 'location', 'did_number', 'note'
                ];
                dbQuery = dbQuery.or(buildOrFilter(query, columns));
            }

            const { data, error } = await dbQuery;
            
            if (error) throw error;

            // Log Search
            if (query && currentUser) {
                 logModification('search_logs', 'SEARCH', null, `搜尋分機: ${query}`, null, null).catch(e => console.error('Log search error:', e));
            }
            
            phoneData = data;
            if (data) countEl.innerText = `搜尋結果: ${data.length} 筆`;
            renderPhoneTable(data, query);
            
        } catch (error) {
            console.error('Search error:', error);
            container.innerHTML = '<div style="color:red; text-align:center;">載入失敗: ' + error.message + '</div>';
        }
    }

    function renderPhoneTable(data, query = '') {
        const container = document.getElementById('phonesTableContainer');
        if (!data.length) { container.innerHTML = '無資料'; return; }
        
        const isEditable = !!currentUser;
        
        // Split data if query exists and exact match found
        let displayData = data;
        let hiddenData = [];
        
        if (query) {
             const exactMatches = data.filter(row => row.extension === query);
             if (exactMatches.length > 0) {
                 const otherMatches = data.filter(row => row.extension !== query);
                 displayData = exactMatches;
                 hiddenData = otherMatches;
             }
        }

        // Define columns
        const columns = [
            { key: 'extension', label: '號碼', highlight: true },
            { key: 'unit', label: '單位' },
            { key: 'lens', label: 'LENS' },
            { key: 'mdf_port', label: '機房端子編號' },
            { key: 'remote_mc_id', label: '遠端機櫃 MC-ID - (第幾對線)' },
            { key: 'UG50_port', label: '遠端機櫃UG-50 - 編號' },
            { key: 'line_group_id', label: '線組編號' },
            { key: 'did_number', label: 'DID' },
            { key: 'location', label: '裝機位置' },
            { key: 'call_class', label: '通話等級' },
            { key: 'sub_count', label: '副機數量' },
            { key: 'type', label: '數位' },
            { key: 'note', label: '備註' }
        ];

        const generateCards = (rows, startIndex = 0) => {
            if (rows.length === 0) return '';
            
            let html = '';
            rows.forEach((row, index) => {
                const globalIndex = startIndex + index + 1;
                html += `<div class="result-card" data-id="${row.id}">
                    <div class="card-header">
                        <span>搜尋結果 #${globalIndex}</span>
                    </div>
                    <div class="card-body">`;
                
                columns.forEach(col => {
                    const val = row[col.key] || '';
                    // Logic: Always render if value exists.
                    // If empty (or just placeholder like '-'):
                    //   - If !isEditable: Don't render (display: none via class or just omit)
                    //   - If isEditable: Render but hidden, so enableEdit can show it.
                    
                    const strVal = String(val).trim();
                    const isEmpty = !strVal || strVal === '-' || strVal === '無資料' || strVal === 'undefined' || strVal === 'null';
                    
                    if (isEmpty && !isEditable) return; // Skip completely for viewers
                    
                    let rowClass = 'info-row';
                    if (isEmpty && isEditable) {
                        rowClass += ' hidden-empty-row'; // Hide initially for editors too
                    }
                    
                    const isHighlight = col.highlight;
                    const valueClass = isHighlight ? 'info-value highlight-bg' : 'info-value';
                    const style = isHighlight ? 'display:inline-block; width:auto; flex-grow:0;' : '';
                    
                    html += `
                    <div class="${rowClass}" data-key-container="${col.key}">
                        <span class="info-label">${col.label} :</span>
                        <span class="${valueClass}" data-key="${col.key}" style="${style}">${val}</span>
                    </div>`;
                });
                
                html += `</div>`; // End card-body
                
                if (isEditable) {
                    let deleteBtn = '';
                    if (currentUser && currentUser.role === 'admin') {
                        deleteBtn = `<button onclick="deletePhone('${row.id}')" style="background:#d32f2f;">刪除</button>`;
                    }
                    
                    html += `
                    <div class="card-actions">
                        <button onclick="enableEdit(this, 'phones')">修改</button>
                        ${deleteBtn}
                    </div>`;
                }
                
                html += `</div>`; // End result-card
            });
            return html;
        };

        let html = generateCards(displayData, 0);

        if (hiddenData.length > 0) {
            html += `<div style="margin-top: 10px; text-align: center;">
                <button id="btn-morePhones" onclick="toggleMore('morePhones', ${hiddenData.length})">顯示其餘 ${hiddenData.length} 筆結果</button>
            </div>`;
            html += `<div id="morePhones" class="hidden">`;
            html += generateCards(hiddenData, displayData.length);
            html += `</div>`;
        }
        
        container.innerHTML = html;

        // Blinking Login Button Effect
        const loginBtn = document.getElementById('loginBtn');
        if (loginBtn) {
            if (!currentUser && data.length > 0) {
                loginBtn.classList.add('blink-orange');
            } else {
                loginBtn.classList.remove('blink-orange');
            }
        }
    }

    // ================= EDIT / SAVE / CANCEL HELPERS =================
    let originalRowData = {};

        function enableEdit(btn, type) {
        const card = btn.closest('.result-card');
        const rowId = card.dataset.id;
        
        // Store original data
        originalRowData[rowId] = card.innerHTML;

        // Reveal hidden empty rows for editing
        const hiddenRows = card.querySelectorAll('.hidden-empty-row');
        hiddenRows.forEach(row => {
            row.classList.remove('hidden-empty-row');
        });

        // Make cells editable
        const values = card.querySelectorAll('.info-value[data-key]');
        values.forEach(div => {
            const key = div.dataset.key;
            // Prevent editing of 'extension' field
            if (key === 'extension') {
                div.style.backgroundColor = '#f5f5f5'; // Visual cue for read-only
                div.style.color = '#888';
                div.title = '分機號碼不可修改';
                return; 
            }

            div.contentEditable = true;
            div.classList.add('editing-cell');
            if (div.innerText === '無資料') div.innerText = '';
        });

        // Change buttons
        const actionDiv = card.querySelector('.card-actions');
        actionDiv.innerHTML = `
            <button class="btn-save" onclick="saveEdit(this, '${rowId}', '${type}')" style="background:#4caf50;">確認</button>
            <button class="btn-cancel" onclick="cancelEdit(this, '${rowId}')" style="background:#757575;">取消</button>
        `;
    }

    function cancelEdit(btn, rowId) {
        const card = btn.closest('.result-card');
        if (originalRowData[rowId]) {
            card.innerHTML = originalRowData[rowId];
            delete originalRowData[rowId];
        }
    }
    
    async function saveEdit(btn, id, table) {
        if (!confirm('確定要修改嗎？')) return;
        
        const card = btn.closest('.result-card');
        const values = card.querySelectorAll('.info-value[data-key]');
        const updates = {};
        
        values.forEach(div => {
            const key = div.dataset.key;
            const value = div.innerText.trim();
            updates[key] = value;
        });
        
        // Detect changes for notification
        let changedDetails = [];
        let extension = updates['extension'] || ''; // Default, will try to find below
        let originalValues = {}; // Moved outside for scope visibility
        
        if (originalRowData[id]) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = originalRowData[id];
            
            tempDiv.querySelectorAll('.info-value[data-key]').forEach(div => {
                originalValues[div.dataset.key] = div.innerText.trim();
            });
            
            // If extension was not in updates (e.g. read-only?), get from original
            if (!extension && originalValues['extension']) {
                extension = originalValues['extension'];
            }
            
            // Compare
            for (const key in updates) {
                let newVal = updates[key];
                let oldVal = originalValues[key] || '';
                
                // Normalize "無資料" or "-" to empty string for comparison
                const normNew = (newVal === '無資料' || newVal === '-') ? '' : newVal;
                const normOld = (oldVal === '無資料' || oldVal === '-') ? '' : oldVal;
                
                if (normNew !== normOld) {
                    // Find label
                    const labelSpan = card.querySelector(`[data-key-container="${key}"] .info-label`);
                    const label = labelSpan ? labelSpan.innerText.replace(' :', '').trim() : key;
                    changedDetails.push(`${label}: ${oldVal} -> ${newVal}`);
                }
            }
        } else {
             // Fallback if original data missing
             changedDetails.push('無法比對原始資料 (Original data missing)');
        }

        const originalBtnText = btn.innerText;
        btn.innerText = '儲存中...';
        btn.disabled = true;
        
        try {
            const tableName = table === 'phones' ? 'phones' : 'dispatch_phones';
            
            const { error } = await supabaseClient
                .from(tableName)
                .update(updates)
                .eq('id', id);
                
            if (error) {
                throw error;
            } else {
                // Send Notification
                const time = new Date().toLocaleString();
                const changeLog = changedDetails.length > 0 ? changedDetails.join('\n') : '無明顯變更';
                
                // Log Modification to DB
                // Use try-catch for log specifically to ensure UI recovery even if log fails
                try {
                    // Include extension in change details
                    const detailedChangeLog = `分機: ${extension}\n${changeLog}`;
                    await logModification(tableName, 'UPDATE', id, detailedChangeLog, originalValues, updates);
                } catch (logErr) {
                    console.error('Logging failed but update succeeded:', logErr);
                }

                sendTelegramNotification(
    `<b>資料修改通知</b>
    修改帳號: ${currentUser.username}
    修改分機: ${extension}
    時間: ${time}
    修改欄位:
    ${changeLog}`
                );
                
                // Success - refresh row state (turn off edit)
                values.forEach(div => {
                    div.contentEditable = false;
                });
                
                const actionDiv = card.querySelector('.card-actions');
                const deleteFunc = table === 'phones' ? `deletePhone('${id}')` : `deleteDispatch('${id}')`;
                
                let deleteBtn = '';
                if (currentUser && currentUser.role === 'admin') {
                    deleteBtn = `<button onclick="${deleteFunc}" style="background:#d32f2f;">刪除</button>`;
                }
                
                actionDiv.innerHTML = `
                    <button onclick="enableEdit(this, '${table}')">修改</button> 
                    ${deleteBtn}
                `;
                
                delete originalRowData[id];
            }
        } catch (error) {
            alert('更新失敗: ' + (error.message || error));
            // Restore button state on error
        } finally {
             // Always restore button state if it's still in "Saving" mode and we are done
             // Note: In success case, we replaced the button HTML, so this might refer to a detached element.
             // But if we failed, we need to restore.
             if (btn && btn.isConnected && btn.innerText === '儲存中...') {
                 btn.innerText = originalBtnText;
                 btn.disabled = false;
             }
        }
    }

    async function updatePhone(id, field, value) {
        // Deprecated - kept for reference or direct calls if any
        if (!currentUser) return;
        await supabaseClient.from('phones').update({ [field]: value }).eq('id', id);
    }
    
    async function deletePhone(id) {
        if (!currentUser) return;
        if(confirm('確定刪除?')) {
            const { data } = await supabaseClient.from('phones').select('*').eq('id', id).single();
            const ext = data ? data.extension : 'Unknown';

            await supabaseClient.from('phones').delete().eq('id', id);

            // Log Modification
            await logModification('phones', 'DELETE', id, `刪除分機: ${ext}`, data, null);

            const time = new Date().toLocaleString();
            sendTelegramNotification(`<b>資料刪除通知 (分機)</b>\n用戶: ${currentUser.username}\n時間: ${time}\n刪除分機: ${ext}`);

            searchPhones();
        }
    }

    async function deleteAllPhones() {
        if (!currentUser || currentUser.role !== 'admin') {
            alert('權限不足');
            return;
        }
        
        // Double confirmation for safety
        if (!confirm('警告：確定要清空所有分機資料嗎？此動作無法復原！')) return;
        if (!confirm('再次確認：真的要刪除全部資料？')) return;
        
        const btn = event.target;
        const originalText = btn.innerText;
        btn.innerText = '刪除中...';
        btn.disabled = true;

        try {
            // Delete all records where id is not null (effectively all records)
            // Use not('id', 'is', null) which is valid for UUIDs
            const { error, count } = await supabaseClient
                .from('phones')
                .delete()
                .not('id', 'is', null);
            
            if (error) throw error;
            
            // Log Modification
            await logModification('phones', 'DELETE_ALL', null, '清空所有分機資料', null, null);

            const time = new Date().toLocaleString();
            sendTelegramNotification(`<b>資料清空通知 (分機)</b>\n用戶: ${currentUser.username}\n時間: ${time}\n動作: 清空所有分機資料`);
            
            alert('已清空所有分機資料');
            searchPhones(); // Refresh view
        } catch (e) {
            console.error('Delete all error:', e);
            alert('清空失敗: ' + e.message);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    // ================= DISPATCH =================
    // dispatchData is declared globally above
    async function searchDispatch() {
        if (!supabaseClient) return;
        const query = document.getElementById('dispatchSearch').value.trim();
        const countEl = document.getElementById('dispatchSearchCount');
        countEl.innerText = '';


        const container = document.getElementById('dispatchTableContainer');
        container.innerHTML = '<div style="text-align:center; padding: 20px;">載入中...</div>';

        try {
            let dbQuery = supabaseClient.from('dispatch_phones').select('*').limit(1000).order('extension');
            
            if (query) {
                const columns = [
                    'extension', 'c_terminal', 'lens', 'line_group_room', 
                    'line_group_site', 'unit', 'location', 'sub_count', 'contact_tel'
                ];
                dbQuery = dbQuery.or(buildOrFilter(query, columns));
            }

            const { data, error } = await dbQuery;
            
            if (error) throw error;

            // Log Search
            if (query && currentUser) {
                 logModification('search_logs', 'SEARCH', null, `搜尋調度: ${query}`, null, null).catch(e => console.error('Log search error:', e));
            }
            
            dispatchData = data;
            if (data) countEl.innerText = `搜尋結果: ${data.length} 筆`;
            renderDispatchTable(data, query);
            
        } catch (error) {
            console.error('Search error:', error);
            container.innerHTML = '<div style="color:red; text-align:center;">載入失敗: ' + error.message + '</div>';
        }
    }

    function renderDispatchTable(data, query = '') {
        const container = document.getElementById('dispatchTableContainer');
        if (!data.length) { container.innerHTML = '無資料'; return; }
        
        const isEditable = !!currentUser;

        // Split data logic
        let displayData = data;
        let hiddenData = [];
        
        if (query) {
             const exactMatches = data.filter(row => row.extension === query);
             if (exactMatches.length > 0) {
                 const otherMatches = data.filter(row => row.extension !== query);
                 displayData = exactMatches;
                 hiddenData = otherMatches;
             }
        }

        // Define columns
        const columns = [
            { key: 'extension', label: '分機號碼', highlight: true },
            { key: 'unit', label: '使用單位' },
            { key: 'c_terminal', label: 'C端子位置' },
            { key: 'line_group_room', label: '線組編號(機房)' },
            { key: 'line_group_site', label: '線組編號(現場)' },
            { key: 'location', label: '裝機位置' },
            { key: 'sub_count', label: '副機數量' },
            { key: 'contact_tel', label: '連絡電話' },
            { key: 'lens', label: 'LENS' }
        ];

        const generateCards = (rows, startIndex = 0) => {
            if (rows.length === 0) return '';
            
            let html = '';
            rows.forEach((row, index) => {
                const globalIndex = startIndex + index + 1;
                html += `<div class="result-card" data-id="${row.id}">
                    <div class="card-header">
                        <span>搜尋結果 #${globalIndex}</span>
                    </div>
                    <div class="card-body">`;
                
                columns.forEach(col => {
                    const val = row[col.key] || '';
                    // Logic: Always render if value exists.
                    // If empty (or just placeholder like '-'):
                    //   - If !isEditable: Don't render (display: none via class or just omit)
                    //   - If isEditable: Render but hidden, so enableEdit can show it.
                    
                    const strVal = String(val).trim();
                    const isEmpty = !strVal || strVal === '-' || strVal === '無資料';
                    
                    if (isEmpty && !isEditable) return; // Skip completely for viewers
                    
                    let rowClass = 'info-row';
                    if (isEmpty && isEditable) {
                        rowClass += ' hidden-empty-row'; // Hide initially for editors too
                    }
                    
                    const isHighlight = col.highlight;
                    const valueClass = isHighlight ? 'info-value highlight-bg' : 'info-value';
                    const style = isHighlight ? 'display:inline-block; width:auto; flex-grow:0;' : '';
                    
                    html += `
                    <div class="${rowClass}" data-key-container="${col.key}">
                        <span class="info-label">${col.label} :</span>
                        <span class="${valueClass}" data-key="${col.key}" style="${style}">${val}</span>
                    </div>`;
                });
                
                html += `</div>`; // End card-body
                
                if (isEditable) {
                    let deleteBtn = '';
                    if (currentUser && currentUser.role === 'admin') {
                        deleteBtn = `<button onclick="deleteDispatch('${row.id}')" style="background:#d32f2f;">刪除</button>`;
                    }

                    html += `
                    <div class="card-actions">
                        <button onclick="enableEdit(this, 'dispatch')">修改</button>
                        ${deleteBtn}
                    </div>`;
                }
                
                html += `</div>`; // End result-card
            });
            return html;
        };

        let html = generateCards(displayData, 0);

        if (hiddenData.length > 0) {
            html += `<div style="margin-top: 10px; text-align: center;">
                <button id="btn-moreDispatch" onclick="toggleMore('moreDispatch', ${hiddenData.length})">顯示其餘 ${hiddenData.length} 筆結果</button>
            </div>`;
            html += `<div id="moreDispatch" class="hidden">`;
            html += generateCards(hiddenData, displayData.length);
            html += `</div>`;
        }
        container.innerHTML = html;

        // Blinking Login Button Effect
        const loginBtn = document.getElementById('loginBtn');
        if (loginBtn) {
            if (!currentUser && data.length > 0) {
                loginBtn.classList.add('blink-orange');
            } else {
                loginBtn.classList.remove('blink-orange');
            }
        }
    }

    async function updateDispatch(id, field, value) {
        if (!currentUser) return;
        await supabaseClient.from('dispatch_phones').update({ [field]: value }).eq('id', id);
    }
    
    async function deleteDispatch(id) {
        if (!currentUser) return;
        if(confirm('確定刪除?')) {
            const { data } = await supabaseClient.from('dispatch_phones').select('*').eq('id', id).single();
            const ext = data ? data.extension : 'Unknown';

            await supabaseClient.from('dispatch_phones').delete().eq('id', id);

            // Log Modification
            await logModification('dispatch_phones', 'DELETE', id, `刪除調度電話: ${ext}`, data, null);

            const time = new Date().toLocaleString();
            sendTelegramNotification(`<b>資料刪除通知 (調度)</b>\n用戶: ${currentUser.username}\n時間: ${time}\n刪除分機: ${ext}`);

            searchDispatch();
        }
    }

    async function deleteAllDispatch() {
        if (!currentUser || currentUser.role !== 'admin') {
            alert('權限不足');
            return;
        }
        
        // Double confirmation for safety
        if (!confirm('警告：確定要清空所有調度電話資料嗎？此動作無法復原！')) return;
        if (!confirm('再次確認：真的要刪除全部資料？')) return;
        
        const btn = event.target;
        const originalText = btn.innerText;
        btn.innerText = '刪除中...';
        btn.disabled = true;

        try {
            // Delete all records where id is not null
            const { error, count } = await supabaseClient
                .from('dispatch_phones')
                .delete()
                .not('id', 'is', null);
            
            if (error) throw error;
            
            // Log Modification
            await logModification('dispatch_phones', 'DELETE_ALL', null, '清空所有調度電話資料', null, null);

            const time = new Date().toLocaleString();
            sendTelegramNotification(`<b>資料清空通知 (調度)</b>\n用戶: ${currentUser.username}\n時間: ${time}\n動作: 清空所有調度電話資料`);
            
            alert('已清空所有調度電話資料');
            searchDispatch(); // Refresh view
        } catch (e) {
            console.error('Delete all error:', e);
            alert('清空失敗: ' + e.message);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    // ================= EXCEL IMPORT/EXPORT =================
    async function exportToExcel(type) {
        if (!supabaseClient) return;
        
        const btn = event.target;
        const originalText = btn.innerText;
        btn.innerText = '匯出中...';
        btn.disabled = true;

        showProgress('準備匯出...', 0);

        try {
            const tableName = type === 'phones' ? 'phones' : 'dispatch_phones';
            
            updateProgress(10, '讀取資料中...');
            
            let data;
            try {
                data = await fetchAllRecords(tableName);
                
                updateProgress(40, '資料排序中...');

                // Sort by extension length (ascending) then by value (numeric)
                // User request: 4 digits first, then 5, then 7, etc. without mixing.
                if (data && data.length > 0) {
                    data.sort((a, b) => {
                        const extA = String(a.extension || '').trim();
                        const extB = String(b.extension || '').trim();
                        
                        // 1. Sort by length
                        if (extA.length !== extB.length) {
                            return extA.length - extB.length;
                        }
                        
                        // 2. Sort by value (numeric aware)
                        return extA.localeCompare(extB, undefined, { numeric: true, sensitivity: 'base' });
                    });
                }
            } catch (error) {
                alert('匯出失敗: ' + error.message);
                console.error(error);
                return;
            }

            if (!data || data.length === 0) {
                alert('無資料可匯出');
                return;
            }

            updateProgress(60, '格式轉換中...');

            let exportData = [];
            if (type === 'phones') {
                // Mapping for phones based on import format
                // ['號碼', '數位', 'LENS', '機房端子編號', '遠端機櫃 MC-ID (第幾對線)', '遠端機櫃UG-50編號', '線組編號', '單位', '裝機位置', '通話等級', '副機數量', 'DID', '備註']
                exportData = data.map(row => ({
                    '號碼': row.extension || '',
                    '數位': row.type || '',
                    'LENS': row.lens || '',
                    '機房端子編號': row.mdf_port || '',
                    '遠端機櫃 MC-ID (第幾對線)': row.remote_mc_id || '',
                    '遠端機櫃UG-50編號': row.UG50_port || '',
                    '線組編號': row.line_group_id || '',
                    '單位': row.unit || '',
                    '裝機位置': row.location || '',
                    '通話等級': row.call_class || '',
                    '副機數量': row.sub_count || '',
                    'DID': row.did_number || '',
                    '備註': row.note || ''
                }));
            } else {
                // Mapping for dispatch
                // ['分機號碼', 'C端子位置', 'LENS', '線組編號(機房)', '線組編號(現場)', '使用單位', '裝機位置', '副機數量', '連絡電話']
                exportData = data.map(row => ({
                    '分機號碼': row.extension || '',
                    'C端子位置': row.c_terminal || '',
                    'LENS': row.lens || '',
                    '線組編號(機房)': row.line_group_room || '',
                    '線組編號(現場)': row.line_group_site || '',
                    '使用單位': row.unit || '',
                    '裝機位置': row.location || '',
                    '副機數量': row.sub_count || '',
                    '連絡電話': row.contact_tel || ''
                }));
            }

            updateProgress(80, '產生 Excel 檔案...');

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, `${type}_data.xlsx`);
            
            updateProgress(100, '匯出完成');
            
            const time = new Date().toLocaleString();
            const label = type === 'phones' ? '分機' : '調度電話';
            
            // Log Export
            await logModification(tableName, 'EXPORT', null, `匯出${label}資料: ${data.length} 筆`, null, null);

            sendTelegramNotification(`<b>資料匯出通知</b>\n用戶: ${currentUser.username}\n時間: ${time}\n類型: ${label}\n筆數: ${data.length}`);
        } catch (e) {
            console.error('Export error:', e);
            alert('匯出發生錯誤');
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
            setTimeout(hideProgress, 1000);
        }
    }

    // Helper to fetch only ID and Extension for mapping
    async function fetchExistingKeys(tableName) {
        let allData = [];
        let from = 0;
        const limit = 1000;
        let hasMore = true;

        while (hasMore) {
            const { data, error } = await supabaseClient
                .from(tableName)
                .select('id, extension') // Fetch only necessary fields
                .range(from, from + limit - 1);
            
            if (error) throw error;

            if (data && data.length > 0) {
                allData = allData.concat(data);
                from += limit;
                if (data.length < limit) hasMore = false;
            } else {
                hasMore = false;
            }
        }
        return allData;
    }

    async function importExcel(type, input) {
        if (!currentUser) return;
        const file = input.files[0];
        if (!file) return;

        showProgress('讀取檔案...', 0);

        const reader = new FileReader();
        reader.onload = async function(e) {
            let validRecords = [];
            const table = type === 'phones' ? 'phones' : 'dispatch_phones';

            // Helper function for batch upsert
            const runBatchUpsert = async (records) => {
                const BATCH_SIZE = 1000;
                let successCount = 0;
                let errorCount = 0;
                let lastError = null;
                
                updateProgress(50, `開始匯入 ${records.length} 筆資料...`);

                for (let i = 0; i < records.length; i += BATCH_SIZE) {
                    const batch = records.slice(i, i + BATCH_SIZE);
                    const progress = 50 + Math.floor((i / records.length) * 40);
                    updateProgress(progress, `匯入中... (${i + 1}/${records.length})`);

                    // Use standard upsert without specific onConflict constraint
                    // Rely on 'id' being present for updates (mapped from extensionMap)
                    const { error } = await supabaseClient.from(table).upsert(batch);  
                    
                    if (error) {
                        console.error('Import batch error:', error);
                        errorCount += batch.length;
                        lastError = error;
                    } else {
                        successCount += batch.length;
                    }
                }
                return { successCount, errorCount, lastError };
            };

            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                // const table is defined in outer scope
                
                // 1. Fetch existing data to handle duplicates manually
                updateProgress(20, '檢查現有資料...');
                
                let existingRecords = [];
                try {
                    existingRecords = await fetchExistingKeys(table);
                } catch (err) {
                    console.error('Error fetching existing keys:', err);
                    alert('匯入前檢查失敗: ' + err.message);
                    hideProgress();
                    return;
                }
                
                // Map extension -> id (Normalize to string and trim)
                const extensionMap = new Map();
                existingRecords.forEach(r => {
                    if (r.extension) extensionMap.set(String(r.extension).trim(), r.id);
                });

                updateProgress(40, '解析資料...');

                // 2. Map Excel columns to DB columns
                const records = jsonData.map(row => {
                    const newRow = {};
                    
                    // Helper to find value from possible headers
                    const getValue = (possibleHeaders) => {
                        for (const header of possibleHeaders) {
                            if (row[header] !== undefined) return row[header];
                            // Try lowercase match
                            const lowerHeader = header.toLowerCase();
                            const rowKey = Object.keys(row).find(k => k.toLowerCase() === lowerHeader);
                            if (rowKey) return row[rowKey];
                        }
                        return undefined;
                    };

                    const MAPPING = {
                        phones: {
                            extension: ['號碼', '分機', 'extension', 'Extension', '分機號碼'],
                            type: ['數位', 'type', '分機種類'],
                            lens: ['LENS', 'lens'],
                            mdf_port: ['機房端子編號', 'mdf_port', 'MDF'],
                            remote_mc_id: ['遠端機櫃 MC-ID (第幾對線)', 'remote_mc_id', 'MC-ID'],
                            UG50_port: ['遠端機櫃UG-50編號', 'UG50_port', 'UG50'],
                            line_group_id: ['線組編號', 'line_group_id'],
                            unit: ['單位', 'unit', '使用單位'],
                            location: ['裝機位置', 'location'],
                            call_class: ['通話等級', 'call_class'],
                            sub_count: ['副機數量', 'sub_count'],
                            did_number: ['DID', 'did_number', 'DID號碼'],
                            note: ['備註', 'note']
                        },
                        dispatch: {
                            extension: ['分機號碼', 'extension', 'Extension', '號碼', '分機'],
                            c_terminal: ['C端子位置', 'c_terminal'],
                            lens: ['LENS', 'lens'],
                            line_group_room: ['線組編號(機房)', 'line_group_room', '機房線組'],
                            line_group_site: ['線組編號(現場)', 'line_group_site', '現場線組'],
                            unit: ['使用單位', 'unit', '單位'],
                            location: ['裝機位置', 'location'],
                            sub_count: ['副機數量', 'sub_count'],
                            contact_tel: ['連絡電話', 'contact_tel']
                        }
                    };

                    const mappingType = type === 'phones' ? 'phones' : 'dispatch';
                    const currentMapping = MAPPING[mappingType];

                    for (const [dbField, headers] of Object.entries(currentMapping)) {
                        const val = getValue(headers);
                        if (val !== undefined) {
                            newRow[dbField] = val;
                        }
                    }
                    
                    // Force extension to string and trim
                    if (newRow.extension !== undefined && newRow.extension !== null) {
                        newRow.extension = String(newRow.extension).trim();
                    }

                    // 3. Check for existing ID to perform Update instead of Insert
                    if (newRow.extension) {
                        const extKey = newRow.extension;
                        if (extensionMap.has(extKey)) {
                            newRow.id = extensionMap.get(extKey);
                        }
                    }
                    
                    return newRow;
                });
                
                // Filter out empty rows
                validRecords = records.filter(r => Object.keys(r).length > 0);

                if (validRecords.length === 0) {
                    alert('無有效資料可匯入');
                    hideProgress();
                    return;
                }

                // Calculate Duplicates (Updates) vs New (Inserts)
                const duplicateCount = validRecords.filter(r => r.id).length;
                const newCount = validRecords.length - duplicateCount;

                // 4. Perform Upsert (Batched)
                let { successCount, errorCount, lastError } = await runBatchUpsert(validRecords);
                
                // Check for errors and prompt for clear & retry if it's 'phones' table AND user is admin
                if (errorCount > 0 && table === 'phones' && currentUser.role === 'admin') {
                     hideProgress(); // Prevent freeze by hiding modal before confirm
                     await new Promise(r => setTimeout(r, 100)); // Allow UI update

                     const confirmClear = confirm(`匯入完成但有 ${errorCount} 筆失敗。\n是否要「清空 phones 資料表」並重新匯入全部資料？\n(注意：這將刪除現有所有分機資料)\n此功能僅限管理員使用。`);
                      if (confirmClear) {
                          showProgress('重試中...');
                          updateProgress(0, '正在清空資料表並重新匯入...');
                          
                          const { error: deleteError } = await supabaseClient
                             .from(table)
                             .delete()
                             .not('id', 'is', null);

                         if (deleteError) {
                             console.error('Clear table error:', deleteError);
                             alert('清空資料表失敗: ' + deleteError.message);
                         } else {
                             await logModification(table, 'DELETE_ALL', null, '匯入錯誤後清空資料表', null, null);
                             
                             const result = await runBatchUpsert(validRecords);
                             successCount = result.successCount;
                             errorCount = result.errorCount;
                             lastError = result.lastError;
                         }
                     }
                }
                
                updateProgress(100, '匯入完成');
                await new Promise(r => setTimeout(r, 500)); // Show completion briefly
                hideProgress(); // Ensure hidden before final alert

                const time = new Date().toLocaleString();
                const label = type === 'phones' ? '分機' : '調度電話';
                const msg = `<b>資料匯入通知</b>\n用戶: ${currentUser.username}\n時間: ${time}\n類型: ${label}\n成功筆數: ${successCount}\n失敗筆數: ${errorCount}`;
                
                // Log Import
                await logModification(table, 'IMPORT', null, `匯入${label}資料: 成功 ${successCount} 筆, 失敗 ${errorCount} 筆`, null, null);

                sendTelegramNotification(msg);

                if (errorCount > 0) {
                    alert(`匯入完成，但有 ${errorCount} 筆失敗 (成功: ${successCount} 筆)\n新增: ${newCount} 筆\n更新(重複): ${duplicateCount} 筆\n失敗原因可能是資料重複或格式錯誤。\n錯誤訊息: ${lastError ? lastError.message : '未知'}`);
                } else {
                    alert(`匯入成功 (共 ${successCount} 筆)\n新增: ${newCount} 筆\n更新(重複): ${duplicateCount} 筆`);
                }
                
                // Reset input
                input.value = '';

                if (type === 'phones') searchPhones(); else searchDispatch();

            } catch (e) {
                console.error('Import error:', e);
                alert('匯入發生錯誤: ' + e.message);
            } finally {
                setTimeout(hideProgress, 1000);
            }
        };
        reader.readAsArrayBuffer(file);
    }

</script>

<!-- Progress Modal -->
<div id="progressModal">
    <div id="progressContent">
        <h3 id="progressTitle" style="color:white; margin-top:0;">處理中...</h3>
        <div id="progressBarContainer">
            <div id="progressBar">0%</div>
        </div>
        <p id="progressMessage" style="color:#ddd; font-size: 0.9em;"></p>
    </div>
</div>

</body>
</html>