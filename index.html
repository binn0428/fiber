<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>光纖管理系統</title>
    <link rel="icon" type="image/webp" href="./光纖圖.jpg">
    <link rel="stylesheet" href="style.css?v=2">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        #protocol-warning {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            color: white;
            z-index: 10000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="protocol-warning">
        <h1>⚠️ 錯誤的開啟方式</h1>
        <p>檢測到您正在使用檔案協定 (file://) 開啟此網頁。</p>
        <p>由於安全性限制，本系統必須透過網頁伺服器開啟。</p>
        <p>請使用終端機執行 <code>npm run dev</code> 並點擊顯示的連結。</p>
    </div>
    <script>
        // Protocol Check
        if (window.location.protocol === 'file:') {
            document.getElementById('protocol-warning').style.display = 'flex';
        }
    </script>
    <script type="module" src="./src/main.js?v=3"></script>
    <button id="mobile-menu-btn">⚙️</button>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">光纖管理系統</div>
            <nav>
                <button class="nav-btn active" data-target="dashboard">儀表板</button>
                <button class="nav-btn" data-target="map-view">光纖架構圖</button>
                <button class="nav-btn" data-target="data-mgmt">資料管理</button>
                <button class="nav-btn" data-target="auto-add">自動新增</button>
                <button class="nav-btn" data-target="io-panel">上傳/匯出</button>
                <div style="flex-grow: 1;"></div>
                <button class="nav-btn" id="mgmt-btn" style="color: var(--warning-color);">管理功能</button>
            </nav>
            <div class="search-box">
                <input type="text" id="global-search" placeholder="搜尋線路編號...">
                <button id="search-btn">🔍</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="view-section active">
                <h2>系統儀表板</h2>
                <div id="stats-container" class="stats-grid">
                    <!-- Statistics will be injected here -->
                    <div class="stat-card">載入中...</div>
                </div>
            </section>

            <!-- Map Section -->
            <section id="map-view" class="view-section">
                <div class="map-header">
                    <button id="map-controls-toggle" class="icon-btn" title="功能選單">☰</button>
                    <button id="restore-sidebar-btn" class="action-btn" style="display: none; margin-right: 10px; background-color: #4b5563;">🔙 顯示選單</button>
                    <h2 id="map-title">光纖架構圖</h2>
                    <div class="map-controls" id="map-controls-menu">
                         <button id="refresh-map-btn" class="action-btn">🔄 重新整理</button>
                         <button id="multi-center-sort-btn" class="action-btn" style="background-color: var(--primary-color);">🎯 多點中心排序</button>
                         <button id="save-map-btn" class="action-btn" style="background-color: var(--success-color); display: none;">💾 儲存佈局</button>
                         <button id="add-link-btn" class="action-btn" style="background-color: var(--primary-color); display: none;">➕ 新增連線</button>
                         <button id="add-station-btn" class="action-btn" style="background-color: var(--primary-color); display: none;">➕ 增加站點</button>
                         <button id="edit-map-btn" class="action-btn" style="background-color: var(--warning-color);">✏️ 編輯架構</button>
                         <button onclick="fixCoreGaps()" class="action-btn admin-only" style="background-color: #f59e0b; display:none;" title="檢查並補齊缺失芯號">🛠️ 補齊芯號</button>
                    </div>
                </div>
                <div class="map-container">
                    <!-- Placeholder for Map. Ideally an SVG or Canvas -->
                    <div id="fiber-map">
                        <div class="map-placeholder">
                            <p>光纖架構圖區域</p>
                            <p>點擊下方模擬站點查看詳情</p>
                            <div class="site-node" data-site="SiteA" style="top: 20%; left: 20%;">站點 A</div>
                            <div class="site-node" data-site="SiteB" style="top: 20%; left: 60%;">站點 B</div>
                            <div class="site-node" data-site="SiteC" style="top: 60%; left: 40%;">站點 C</div>
                            <!-- Connection Lines -->
                            <svg class="connections">
                                <line x1="20%" y1="20%" x2="60%" y2="20%" stroke="blue" stroke-width="2" />
                                <line x1="60%" y1="20%" x2="40%" y2="60%" stroke="blue" stroke-width="2" />
                                <line x1="40%" y1="60%" x2="20%" y2="20%" stroke="blue" stroke-width="2" />
                            </svg>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Data Management Section -->
            <section id="data-mgmt" class="view-section">
                <h2>資料管理</h2>
                <div class="data-controls">
                    <select id="site-selector">
                        <option value="">選擇站點...</option>
                    </select>
                </div>
                <!-- Search Statistics Container -->
                <div id="search-stats-container" class="stats-panel" style="display: none;"></div>
                
                <!-- Bulk Delete Container -->
                <div id="bulk-delete-container" style="margin-bottom: 10px;"></div>

                <div class="table-container">
                    <table id="data-table">
                        <thead>
                            <tr>
                                <th>線路名稱</th>
                                <th>線路目的</th>
                                <th>芯數</th>
                                <th>線路來源</th>
                                <th>跳接線路</th>
                                <th>Port</th>
                                <th>網路起點</th>
                                <th>網路終點</th>
                                <th>用途</th>
                                <th>使用單位</th>
                                <th>聯絡人</th>
                                <th>連絡電話</th>
                                <th>備註</th>
                                <th>站點</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data rows -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Auto Add Section (Renamed from Manual Add) -->
            <section id="auto-add" class="view-section">
                <h2>自動新增與路徑管理</h2>
                
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchAutoTab('gen')">自動生成路徑</button>
                    <button class="tab-btn" onclick="switchAutoTab('mgmt')">路徑管理 (查詢/刪除)</button>
                </div>

                <!-- Tab 1: Auto Generate -->
                <div id="tab-auto-gen" class="tab-content-panel">
                    <div class="form-inline auto-gen-form">
                        <div class="form-group start-node-group">
                            <label>起點站點</label>
                            <input type="text" id="auto-start-node" list="station-list" placeholder="輸入起點">
                        </div>
                        <div class="form-group end-node-group">
                            <label>終點站點</label>
                            <input type="text" id="auto-end-node" list="station-list" placeholder="輸入終點">
                        </div>
                        <div class="form-group core-count-group">
                            <label>芯數</label>
                            <input type="number" id="auto-core-count" placeholder="1" value="1" min="1">
                        </div>
                        <button id="generate-path-btn" class="btn-primary gen-btn">生成路徑</button>
                        <button id="clear-path-btn" class="btn-primary gen-btn" style="background-color: #6c757d; margin-left: 5px;">清除</button>
                    </div>

                    <div id="path-results" class="path-results-container" style="display:none;">
                        <h3>建議路徑 (請選擇一條，最多 5 條)</h3>
                        <div id="path-list" class="path-list" style="display: flex; flex-direction: column; gap: 10px;"></div>
                    </div>

                    <div id="path-details-form" class="data-form" style="display:none; margin-top: 20px; border-top: 1px solid #444; padding-top: 20px;">
                        <h3>填寫線路資料</h3>
                        <p id="selected-path-info" style="color: var(--primary-color); margin-bottom: 10px; font-weight: bold;"></p>
                        
                        <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div class="form-group">
                                <label>Port</label>
                                <input type="text" id="auto-port">
                            </div>
                            <div class="form-group">
                                <label>用途 (Usage)</label>
                                <input type="text" id="auto-usage">
                            </div>
                            <div class="form-group">
                                <label>使用單位</label>
                                <input type="text" id="auto-department">
                            </div>
                            <div class="form-group">
                                 <label>聯絡人</label>
                                 <input type="text" id="auto-contact">
                            </div>
                            <div class="form-group">
                                 <label>備註</label>
                                 <input type="text" id="auto-notes">
                            </div>
                        </div>

                        <button id="confirm-auto-add-btn" class="btn-primary" style="background-color: var(--success-color); width: 100%; margin-top: 15px;">確認新增並佔用線路</button>
                    </div>
                </div>

                <!-- Tab 2: Management -->
                <div id="tab-auto-mgmt" class="tab-content-panel" style="display:none;">
                    <div class="search-box">
                         <select id="path-history-select">
                            <option value="">-- 選擇歷史路徑紀錄 --</option>
                         </select>
                         <input type="text" id="path-search" placeholder="搜尋用途、備註或站點...">
                         <button id="path-search-btn">🔍</button>
                         <button id="path-refresh-btn" class="action-btn">🔄 重新整理</button>
                    </div>
                    <div id="mgmt-path-list" class="path-list">
                        <!-- List of created paths/circuits -->
                        <p>輸入關鍵字查詢已建立的自動路徑...</p>
                    </div>
                </div>
                
                <datalist id="station-list"></datalist>
            </section>

            <!-- IO Section -->
            <section id="io-panel" class="view-section">
                <h2>上傳 / 匯出</h2>
                <div class="io-card">
                    <h3>匯入 Excel</h3>
                    <p>請上傳包含多個分頁（站點）的 .xlsx 檔案</p>
                    <input type="file" id="excel-upload" accept=".xlsx, .xls" multiple>
                    <button id="process-upload-btn">解析並上傳</button>
                </div>
                <div class="io-card">
                    <h3>匯出 Excel</h3>
                    <p>將當前系統資料匯出為 .xlsx</p>
                    <button id="export-btn">下載 Excel</button>
                </div>
                <div class="io-card">
                    <h3>Supabase 設定</h3>
                    <input type="text" id="supabase-url" placeholder="Supabase URL">
                    <input type="password" id="supabase-key" placeholder="Supabase Key">
                    <button id="save-config-btn">儲存設定</button>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <!-- Path Modal -->
    <div id="path-modal" class="modal hidden">
        <div class="modal-content large-modal">
            <span class="close-modal">&times;</span>
            <h2 id="modal-path-title">光纖路徑圖</h2>
            <div id="path-container" class="path-diagram">
                <!-- Path visualization will be here -->
            </div>
        </div>
    </div>

    <!-- Site Details Modal -->
    <div id="site-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3 id="modal-site-title">站點詳情</h3>
            <div id="modal-site-stats"></div>
            <div class="modal-table-wrapper">
                <!-- Accordion Container -->
                <div id="site-accordion-container">
                    <!-- Dynamic Accordion Items will be injected here -->
                </div>
                
                <!-- Fallback or Hidden Table for reference/export if needed -->
                <table id="modal-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>站點</th>
                            <th>線路名稱</th>
                            <th>目的</th>
                            <th>芯數</th>
                            <th>來源</th>
                            <th>Port</th>
                            <th>用途</th>
                            <th>備註</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal hidden">
        <div class="modal-content sm">
            <span class="close-modal">&times;</span>
            <h3>編輯 Port 資訊</h3>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <label>用途</label>
                    <input type="text" id="edit-usage">
                </div>
                <div class="form-group">
                    <label>備註</label>
                    <input type="text" id="edit-remarks">
                </div>
                <button type="submit">儲存</button>
            </form>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal hidden">
        <div class="modal-content sm login-content">
            <span class="close-modal">&times;</span>
            <div class="login-header">
                <h3>管理員登入</h3>
                <p>請輸入密碼以存取管理功能</p>
            </div>
            <form id="login-form">
                <div class="form-group">
                    <label>密碼</label>
                    <input type="password" id="login-password" placeholder="請輸入密碼" required>
                </div>
                <div class="login-actions">
                    <button type="submit" class="btn-primary full-width">登入</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Path Modal -->
    <div id="edit-path-modal" class="modal hidden">
        <div class="modal-content sm">
            <span class="close-modal">&times;</span>
            <h3>編輯路徑資料</h3>
            <form id="edit-path-form">
                <input type="hidden" id="edit-path-id">
                <div class="form-group">
                    <label>用途</label>
                    <input type="text" id="edit-path-usage" required>
                </div>
                <div class="form-group">
                    <label>使用單位</label>
                    <input type="text" id="edit-path-department">
                </div>
                <div class="form-group">
                    <label>聯絡人</label>
                    <input type="text" id="edit-path-contact">
                </div>
                <div class="form-group">
                    <label>備註 (PathID 將自動保留)</label>
                    <input type="text" id="edit-path-notes">
                </div>
                <button type="submit" class="btn-primary full-width">儲存變更</button>
            </form>
        </div>
    </div>
</body>
</html>
